<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divine Pudim Gourmet - Sistema V23 (Corre√ß√£o Conex√£o)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* ================= ESTILOS GERAIS ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #ec4899; --primary-dark: #be185d; --primary-light: #fdf2f8;
            --accent: #ffd700; --white: #ffffff;
            --gray-50: #fafafa; --gray-100: #f5f5f5; --gray-200: #e5e5e5;
            --gray-600: #525252; --gray-800: #262626;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --transition: all 0.3s ease;
        }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%); color: var(--gray-800); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        /* LOGIN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary); }
        .btn-login { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-login:hover { background: var(--primary-dark); transform: translateY(-2px); }

        /* HEADER E BOT√ïES */
        #appContent { display: none; padding-bottom: 40px; }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--white); padding: 20px 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .logo { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--accent); font-size: 28px; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: var(--transition); }
        .btn-header { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-header:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: var(--accent); color: var(--gray-800); font-weight: 700; box-shadow: var(--shadow); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-800); }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-dark { background: #1e293b; color: white; } 
        .btn-success { background: #22c55e; color: white; }
        .btn-warning { background: #f59e0b; color: white; }

        /* TABS */
        .tabs-nav { background: var(--white); padding: 10px 0; position: sticky; top: 70px; z-index: 990; box-shadow: var(--shadow); margin-bottom: 20px; overflow-x: auto; }
        .tabs-buttons { display: flex; gap: 10px; padding: 0 20px; min-width: max-content; }
        .tab-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; color: var(--gray-600); font-weight: 600; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--primary-light); border-radius: 8px 8px 0 0; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS E LISTAS */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: center; }
        .card-row { display: flex; align-items: center; gap: 15px; }
        .card-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; flex-shrink: 0; }
        
        .search-bar, .filters { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-family: inherit; }
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }

        /* PEDIDO CARD */
        .order-card { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; position: relative; transition: transform 0.2s; }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .order-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 12px; background: var(--card-color, var(--primary)); }
        .order-header { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .order-id { font-weight: 800; font-size: 16px; color: var(--gray-800); }
        .order-date { font-size: 12px; color: var(--gray-600); }
        .order-body { padding: 15px; flex: 1; }
        .client-info { margin-bottom: 12px; }
        .client-name { font-weight: 700; font-size: 15px; display: block; margin-bottom: 2px; color:#333; }
        .client-detail { font-size: 13px; color: #666; display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .items-box { background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 10px 0; border: 1px dashed #ddd; }
        .item-line { font-size: 13px; margin-bottom: 4px; display: flex; justify-content: space-between; color:#444; }
        .finance-box { margin-top: 10px; font-size: 13px; }
        .finance-row { display: flex; justify-content: space-between; margin-bottom: 3px; color: #666; }
        .finance-total { font-weight: 800; font-size: 15px; color: var(--gray-800); margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
        .payment-highlight { background: #fef2f2; border: 1px solid #fee2e2; color: #b91c1c; padding: 8px; border-radius: 6px; margin-top: 8px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .status-select { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; border: none; cursor: pointer; outline: none; color: white; text-align: center; appearance: none; -webkit-appearance: none; }
        .order-footer { padding: 12px 15px 12px 25px; background: #fafafa; border-top: 1px solid #f0f0f0; display: flex; gap: 8px; }
        .btn-card { flex: 1; justify-content: center; background: white; border: 1px solid #ddd; font-size: 12px; color: #555; padding:8px; border-radius:6px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:5px; }
        .btn-card:hover { background: var(--primary-light); color: var(--primary-dark); border-color: var(--primary-light); }
        .card-confirmado { --card-color: #111827; }
        .card-produzindo { --card-color: #facc15; }
        .card-pronto { --card-color: #3b82f6; }     
        .card-rota { --card-color: #ec4899; }        
        .card-entregue { --card-color: #22c55e; } 

        /* ROTAS */
        .route-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        .route-list { background: #fff; padding: 10px; border-radius: 12px; min-height: 500px; border: 1px solid #e5e7eb; box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05); }
        .route-map-placeholder { background: white; border-radius: 12px; padding: 20px; height: fit-content; box-shadow: var(--shadow); position: sticky; top: 140px; }
        .route-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 15px; cursor: grab; border-left: 5px solid var(--primary); transition: transform 0.1s, box-shadow 0.2s; position: relative; }
        .route-item:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background: #fdf2f8; border: 2px dashed var(--primary); }
        .sortable-drag { background: #fff; opacity: 1; box-shadow: 0 15px 30px rgba(0,0,0,0.2); transform: scale(1.02); }
        .route-number { background: var(--gray-800); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0; }
        .route-details { flex: 1; user-select: none; }
        .route-addr { font-size: 14px; color: #333; font-weight: 600; margin-bottom: 2px; }
        .route-bairro { font-size: 12px; color: #666; background: #f1f5f9; padding: 2px 8px; border-radius: 10px; display: inline-block; font-weight: 600; }
        .route-handle { color: #ccc; padding: 5px; font-size: 18px; }
        #apiLoading { display: none; margin-top: 10px; background: #f0f9ff; padding: 10px; border-radius: 8px; border: 1px solid #bae6fd; color: #0369a1; text-align: center; font-weight: bold; }
        .loading-bar-bg { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .loading-bar-fill { height: 100%; background: #0ea5e9; width: 0%; transition: width 0.3s; }

        @media(max-width: 900px) { .route-container { grid-template-columns: 1fr; } .route-map-placeholder { order: -1; position: static; } }
        @media(max-width: 768px) { .items-header { display: none; } .item-row { grid-template-columns: 1fr; } .header-content { flex-direction: column; } }
        
        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 950px; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-body { padding: 30px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        @media print { body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 58mm; padding: 0; margin: 0; font-size: 12px; font-family: monospace; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <div class="login-logo"><i class="fas fa-birthday-cake"></i></div>
        <h2 style="margin-bottom:20px; color:var(--gray-800)">Divine Pudim Gourmet</h2>
        <form onsubmit="handleLogin(event)">
            <input type="text" id="loginUser" class="login-input" placeholder="Usu√°rio" required>
            <input type="password" id="loginPass" class="login-input" placeholder="Senha" required>
            <button type="submit" class="btn-login">Entrar</button>
        </form>
    </div>
</div>

<div id="appContent">
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo"><i class="fas fa-birthday-cake"></i> Divine Pudim Gourmet</div>
                <div class="header-actions">
                    <button class="btn btn-header" onclick="openPrintConfig()"><i class="fas fa-cog"></i> Config. Impress√£o/API</button>
                    <button class="btn btn-header" onclick="exportBackup()">Backup</button>
                    <button class="btn btn-header" onclick="document.getElementById('importInput').click()">Importar</button>
                    <button class="btn btn-primary" onclick="showNewOrderModal()">+ Novo Pedido</button>
                    <button class="btn btn-danger" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </header>

    <div id="alertsArea"></div>

    <nav class="tabs-nav">
        <div class="container">
            <div class="tabs-buttons">
                <button class="tab-btn active" onclick="showTab(event, 'dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
                <button class="tab-btn" onclick="showTab(event, 'pedidos')"><i class="fas fa-list"></i> Pedidos</button>
                <button class="tab-btn" onclick="showTab(event, 'rotas')"><i class="fas fa-map-marked-alt"></i> Rotas de Entrega</button>
                <button class="tab-btn" onclick="showTab(event, 'graficos')"><i class="fas fa-chart-pie"></i> Gr√°ficos</button>
            </div>
        </div>
    </nav>

    <section id="tabDashboard" class="tab-content active">
        <div class="container">
            <div class="dashboard-grid" style="margin-bottom: 10px;">
                <div class="card"><div class="card-row"><div class="card-icon" style="background:var(--primary)"><i class="fas fa-list"></i></div><div><h3 id="dashTotal">0</h3><p>Total Geral</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#facc15"><i class="fas fa-fire"></i></div><div><h3 id="dashProduzindo">0</h3><p>Produzindo</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#3b82f6"><i class="fas fa-check"></i></div><div><h3 id="dashPronto">0</h3><p>Prontos</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#ec4899"><i class="fas fa-motorcycle"></i></div><div><h3 id="dashRota">0</h3><p>Em Rota</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#22c55e"><i class="fas fa-flag-checkered"></i></div><div><h3 id="dashEntregue">0</h3><p>Entregues</p></div></div></div>
            </div>
            <div class="dashboard-grid">
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#8b5cf6"><i class="fas fa-dollar-sign"></i></div><div><h3 id="dashFaturado">R$ 0,00</h3><p>Faturado (Total)</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#10b981"><i class="fas fa-hand-holding-usd"></i></div><div><h3 id="dashRecebido">R$ 0,00</h3><p>Recebido</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#ef4444"><i class="fas fa-money-bill-wave"></i></div><div><h3 id="dashReceber">R$ 0,00</h3><p>A Receber</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#06b6d4"><i class="fas fa-road"></i></div><div><h3 id="dashTaxas">R$ 0,00</h3><p>Taxas Entrega</p></div></div></div>
            </div>
            <div class="card" style="display: block;">
                <h3 style="border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 15px;"><i class="fas fa-box-open"></i> Quantidade de produtos pedidos</h3>
                <div id="topProductsList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px;"></div>
            </div>
        </div>
    </section>

    <section id="tabPedidos" class="tab-content">
        <div class="container">
            <div class="filters">
                <div class="search-bar"><input type="text" id="searchInput" placeholder="Buscar cliente..." oninput="searchOrders()"></div>
                <div class="filters-grid">
                    <div><label>Data</label><input type="date" id="filterData" onchange="applyFilters()"></div>
                    <div><label>Bairro</label><select id="filterBairro" onchange="applyFilters()"><option value="">Todos</option></select></div>
                    <div><label>Tipo Entrega</label><select id="filterTipo" onchange="applyFilters()"><option value="">Todos</option><option value="Delivery">Delivery</option><option value="Retirada no local">Retirada</option></select></div>
                    <div><label>Turno</label><select id="filterTurno" onchange="applyFilters()"><option value="">Todos</option><option value="Manh√£">Manh√£</option><option value="Tarde">Tarde</option></select></div>
                    <div><label>Status</label><select id="filterStatus" onchange="applyFilters()"><option value="">Todos</option><option value="Pedido confirmado">Confirmado</option><option value="Produzindo">Produzindo</option><option value="Pronto">Pronto</option><option value="Em rota">Em rota</option><option value="Entregue">Entregue</option></select></div>
                    <div style="display:flex; align-items:end;"><button class="btn btn-secondary" onclick="clearFilters()" style="width:100%">Limpar</button></div>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
                    <button class="btn btn-dark" onclick="exportProductSummary()" style="color:white; font-weight:bold"><i class="fas fa-list-ol"></i> Resumo de Produ√ß√£o (Lista)</button>
                    <button class="btn btn-secondary" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Baixar Excel</button>
                </div>
            </div>
            <div id="ordersList" class="orders-grid"></div>
        </div>
    </section>

    <section id="tabRotas" class="tab-content">
        <div class="container">
            <div class="filters" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px">
                <div style="display:flex; gap:15px; align-items:center;">
                    <h2 style="color:var(--primary-dark)"><i class="fas fa-route"></i> Gest√£o de Rotas</h2>
                    <select id="routeTurnoSelector" onchange="renderRoutes()" style="padding:10px; border-radius:8px; border:2px solid var(--primary); font-weight:bold; width:200px">
                        <option value="Manh√£">Rota da MANH√É ‚òÄÔ∏è</option>
                        <option value="Tarde">Rota da TARDE üå§Ô∏è</option>
                    </select>
                </div>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-secondary" onclick="autoSortRouteLogic()"><i class="fas fa-list-ol"></i> Organizar por Bairro</button>
                    <button class="btn btn-warning" onclick="optimizeRouteWithAI()"><i class="fas fa-brain"></i> <b>Otimizar com IA (GPS)</b></button>
                    <button class="btn btn-success" onclick="openGoogleMapsRoute()"><i class="fas fa-map-marker-alt"></i> Abrir no Google</button>
                </div>
            </div>

            <div class="route-container">
                <div style="display:flex; flex-direction:column; gap:10px">
                    <div id="apiLoading">
                        <span id="loadingText">Otimizando rota com Intelig√™ncia Artificial...</span>
                        <div class="loading-bar-bg"><div class="loading-bar-fill" id="loadingBar"></div></div>
                    </div>
                    <div id="routeListArea" class="route-list">
                        <p style="text-align:center; color:#999; margin-top:20px">Selecione um turno para ver a rota.</p>
                    </div>
                </div>

                <div class="route-map-placeholder">
                    <h3 style="margin-bottom:15px; color:var(--gray-800)">Resumo da Rota</h3>
                    <div style="margin-bottom:20px; font-size:14px; color:#555">
                        <p><i class="fas fa-truck"></i> Entregas: <strong id="routeCount">0</strong></p>
                        <p><i class="fas fa-clock"></i> Turno: <strong id="routeTurnoDisplay">-</strong></p>
                        <p style="margin-top:10px; font-size:12px; line-height:1.4">
                            <i>* Arraste os cart√µes na lista ao lado para ajustar a ordem.</i><br>
                            <i>* Sa√≠da: Rua Apolo XI, 519.</i>
                        </p>
                    </div>
                    <hr style="margin:15px 0; border:0; border-top:1px solid #eee">
                    <div style="text-align:center">
                        <div style="background:#e0f2fe; padding:15px; border-radius:8px; color:#0369a1; margin-bottom:15px">
                            <i class="fas fa-info-circle"></i><br>
                            Para usar a Otimiza√ß√£o GPS, configure a API Key no menu.
                        </div>
                        <img src="https://www.google.com/images/branding/product/2x/maps_96in128dp.png" alt="Maps" style="width:64px; opacity:0.8">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="tabGraficos" class="tab-content">
        <div class="container">
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <div class="card" style="display:block; min-height:350px"><h3>Produtos</h3><div style="height:300px; position:relative;"><canvas id="chartProd"></canvas></div></div>
                <div class="card" style="display:block; min-height:350px"><h3>Faturamento</h3><div style="height:300px; position:relative;"><canvas id="chartFat"></canvas></div></div>
            </div>
        </div>
    </section>
</div>

<div id="printConfigModal" class="modal">
    <div class="modal-content" style="max-width:500px">
        <div class="modal-header">
            <h2>Configura√ß√µes</h2>
            <button onclick="document.getElementById('printConfigModal').classList.remove('active')" style="background:none; border:none; color:white; font-size:24px; cursor:pointer">√ó</button>
        </div>
        <div class="modal-body">
            <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px">Impress√£o Cupom</h4>
            <div class="form-row" style="grid-template-columns: 1fr;">
                <div><label>T√≠tulo da Loja</label><input type="text" id="cfgTitle" placeholder="Ex: DIVINE PUDIM"></div>
                <div><label>Subt√≠tulo</label><input type="text" id="cfgSubtitle" placeholder="Ex: GOURMET"></div>
                <div><label>Telefone</label><input type="text" id="cfgPhone" placeholder="Ex: 88 98824-4346"></div>
                <div><label>Rodap√© Cupom</label><input type="text" id="cfgMsg"></div>
            </div>
            
            <h4 style="margin:15px 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px; color:#f59e0b">Integra√ß√£o API (Opcional)</h4>
            <div style="font-size:12px; color:#666; margin-bottom:5px">Cole aqui sua chave do <b>OpenRouteService</b> para usar a Otimiza√ß√£o com IA.</div>
            <input type="text" id="cfgApiKey" placeholder="Cole sua API Key aqui..." style="font-family:monospace; background:#fffbeb; border-color:#fcd34d">
            
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <button class="btn btn-secondary" onclick="resetPrintConfig()">Restaurar</button>
                <button class="btn btn-primary" onclick="savePrintConfig()">Salvar Configura√ß√£o</button>
            </div>
        </div>
    </div>
</div>

<div id="orderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Novo Pedido</h2>
            <button onclick="closeOrderModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer">√ó</button>
        </div>
        <form id="orderForm" onsubmit="saveOrder(event)">
            <div class="modal-body">
                <div class="form-row">
                    <div><label>Nome *</label><input type="text" id="cliNome" required></div>
                    <div><label>WhatsApp *</label><input type="tel" id="cliTel" required></div>
                    <div><label>Forma de Entrega *</label>
                        <select id="tipoEntrega" onchange="checkTipoEntrega()" required>
                            <option value="">Selecione</option>
                            <option value="Delivery">Delivery</option>
                            <option value="Retirada no local">Retirada no local</option>
                        </select>
                    </div>
                </div>
                <div id="deliveryFields" style="display:none; background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                    <h4 style="margin-bottom:10px; color:var(--primary)">Dados de Entrega</h4>
                    <div class="form-row">
                        <div><label>CEP</label><div style="display:flex; gap:5px"><input type="text" id="cliCep" onblur="buscarCep()"><button type="button" class="btn btn-secondary" onclick="buscarCep()"><i class="fas fa-search"></i></button></div></div>
                        <div style="grid-column: span 1"><label>Endere√ßo *</label><input type="text" id="cliEnd"></div>
                        <div><label>N√∫mero (N¬∫)</label><input type="text" id="cliNumero"></div>
                    </div>
                    <div class="form-row">
                        <div><label>Bairro *</label><select id="cliBairro" onchange="checkBairro()"><option value="">Selecione</option></select><input type="text" id="cliBairroOutro" style="display:none; margin-top:5px" placeholder="Digite o bairro"></div>
                        <div><label>Turno da Entrega *</label>
                            <select id="turnoEntrega">
                                <option value="">Selecione</option>
                                <option value="Manh√£">Manh√£</option>
                                <option value="Tarde">Tarde</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="retiradaFields" style="display:none; background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                    <h4 style="margin-bottom:10px; color:var(--primary)">Dados de Retirada</h4>
                    <div class="form-row">
                        <div><label>Hor√°rio da Retirada (Opcional)</label><input type="time" id="horarioRetirada"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div><label>Data Pedido</label><input type="date" id="dataPed" required></div>
                    <div><label>Data Entrega</label><input type="date" id="dataEnt" required></div>
                    <div><label>Status</label>
                        <select id="statusPed">
                            <option value="Pedido confirmado">Confirmado</option>
                            <option value="Produzindo">Produzindo</option>
                            <option value="Pronto">Pronto</option>
                            <option value="Em rota">Em rota</option>
                            <option value="Entregue">Entregue</option>
                        </select>
                    </div>
                </div>
                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee">
                <h3>Itens</h3>
                <div class="items-header"><div>Produto</div><div>Tamanho</div><div>Qtd</div><div>V. Unit</div><div>V. Total</div><div></div></div>
                <div id="itemsContainer"></div>
                <button type="button" class="btn btn-primary" onclick="addItem()" style="width:100%; margin-top:10px">+ Adicionar Item</button>
                <div style="text-align:right; font-size:18px; font-weight:bold; margin-top:15px; color:var(--primary-dark)">Total: <span id="displayTotal">R$ 0,00</span></div>
                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee">
                <h3 style="margin-bottom:15px; color:var(--gray-800)">Pagamento</h3>
                <div style="margin-bottom:15px; background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:bold; font-size:14px; color:#0369a1">
                        <input type="checkbox" id="checkAdiantamento" onchange="toggleAdiantamento()" style="width:18px; height:18px">
                        Recebeu valor antecipado (Sinal)?
                    </label>
                </div>
                <div class="form-row">
                    <div id="areaAdiantamento" style="display:none; grid-template-columns: 1fr 1fr; gap:15px; grid-column: span 2; background:#f0fdf4; padding:10px; border-radius:8px; border:1px solid #bbf7d0">
                        <div><label style="color:#166534">Valor Pago (Sinal)</label><div class="input-group"><span>R$</span><input type="number" step="0.01" id="valPago" oninput="calcTotal()"></div></div>
                        <div><label style="color:#166534">Forma Pagto (Sinal)</label>
                            <select id="formaPagSinal">
                                <option value="">Selecione</option>
                                <option value="Pix">Pix</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cart√£o">Cart√£o</option>
                                <option value="A decidir">A decidir</option>
                            </select>
                        </div>
                    </div>
                    <div style="grid-column: span 2" id="divFormaRestante">
                        <label id="lblFormaRestante">Forma de Pagamento (Valor Total)</label>
                        <select id="formaPagRestante">
                            <option value="">Selecione...</option>
                            <option value="Pix">Pix</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cart√£o">Cart√£o</option>
                            <option value="A decidir">A decidir</option>
                        </select>
                    </div>
                    <div><label>Taxa Entrega</label><div class="input-group"><span>R$</span><input type="number" step="0.01" id="valTaxa" oninput="calcTotal()"></div></div>
                    <div><label>Restante a Pagar</label><div class="input-group"><span>R$</span><input type="text" id="valRest" readonly style="font-weight:bold; color:red"></div></div>
                </div>
                <div style="margin-top:10px"><label>Observa√ß√£o</label><textarea id="obs" rows="2"></textarea></div>
                <input type="hidden" id="editFirebaseId">
                <div style="margin-top:30px; display:flex; justify-content:flex-end; gap:10px">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Pedido</button>
                </div>
            </div>
        </form>
    </div>
</div>

<input type="file" id="importInput" style="display:none" onchange="handleImport(event)" accept=".json">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // =======================================================
    // √ÅREA DE CONFIGURA√á√ÉO FIXA DA API (COLE A CHAVE AQUI)
    // =======================================================
    // Cole sua chave abaixo (ela come√ßa com 5b3ce...)
    const API_KEY_FIXA = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjhiMzlhNjY4YWE4NTQxMzg5MDI1MzUxYTY1NTQ3MDM5IiwiaCI6Im11cm11cjY0In0="; 
    // =======================================================

    const firebaseConfig = {
      apiKey: "AIzaSyBt_7_WLXqUvYqdCrTMQg7ySZUa4gSdEHY",
      authDomain: "divinepudimsystem.firebaseapp.com",
      projectId: "divinepudimsystem",
      storageBucket: "divinepudimsystem.firebasestorage.app",
      messagingSenderId: "529626240432",
      appId: "1:529626240432:web:ca9c80a061a555f6007275"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "pedidos");

    const PRODUTOS = [
        { nome: 'Del√≠cia de abacaxi', tamanhos: [{t:'P',p:35}, {t:'G',p:55}] },
        { nome: 'Ouro branco', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Sonho de valsa', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Supreme de morango', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Bombom de morango', tamanhos: [{t:'P',p:50}, {t:'G',p:85}] },
        { nome: 'Bombom de uva', tamanhos: [{t:'P',p:50}, {t:'G',p:85}] },
        { nome: 'Kinder Bueno', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Torta de brownie', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Ferrero Rocher', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Pudim tradicional', tamanhos: [{t:'M',p:35}, {t:'G',p:75}] },
        { nome: 'Pudim ninho com Nutella', tamanhos: [{t:'M',p:50}, {t:'G',p:85}] },
        { nome: 'Pudim ninho com geleia de morango', tamanhos: [{t:'M',p:50}, {t:'G',p:85}] },
        { nome: 'Brownietone', tamanhos: [{t:'250g',p:25}, {t:'500g',p:55}] },
        { nome: 'Sobremesa na ta√ßa - Del√≠cia de abacaxi', tamanhos: [{t:'√önico',p:100}] },
        { nome: 'Sobremesa na ta√ßa - Torta brownie', tamanhos: [{t:'√önico',p:120}] },
        { nome: '4 brigadeiros', tamanhos: [{t:'√önico',p:14}] },
        { nome: '4 mini brownies recheados', tamanhos: [{t:'√önico',p:18}] },
        { nome: 'Mini bolo', tamanhos: [{t:'√önico',p:15}], requerSabor: true },
        { nome: 'Bolo m√©dio', tamanhos: [{t:'√önico',p:50}], requerSabor: true },
        { nome: 'Empad√£o de carne de sol', tamanhos: [{t:'√önico',p:85}] },
        { nome: 'Empad√£o de frango', tamanhos: [{t:'√önico',p:85}] }
    ];

    const BAIRROS = [
        "Aeroporto", "Ant√¥nio Vieira", "Betol√¢ndia", "Brejo Seco", "Campo Alegre", 
        "Carit√©", "Centro", "Cidade Universit√°ria", "Franciscanos", "Frei Dami√£o", 
        "Horto", "Jardim Gonzaga", "Jo√£o Cabral", "Jos√© Geraldo da Cruz", "Juv√™ncio Santana", 
        "Lagoa Seca", "Leandro Bezerra de Menezes", "Limoeiro", "Monsenhor Francisco de S√° Barreto", 
        "Monsenhor Murilo de S√° Barreto", "Novo Juazeiro", "Palmeirinha", "Parque S√£o Geraldo", 
        "Pedrinhas", "Pio XII", "Piraj√°", "Planalto", "Professora Maria Geli", "Romeir√£o", 
        "Salesianos", "Salgadinho", "Santa Teresa", "S√£o Jos√©", "S√£o Miguel", "Socorro", 
        "Tiradentes", "Tr√™s Marias", "Tri√¢ngulo", "OUTRO"
    ];

    const SEQUENCIA_LOGICA_BAIRROS = [
        "Salesianos", "Santo Ant√¥nio", "Santa Teresa", "Socorro", "Centro", "S√£o Miguel",
        "Romeir√£o", "Piraj√°", "Franciscanos", "Limoeiro", "Jo√£o Cabral", "Horto",
        "Tri√¢ngulo", "Ant√¥nio Vieira", "S√£o Jos√©", "Frei Dami√£o", "Jardim Gonzaga",
        "Lagoa Seca", "Planalto", "Cidade Universit√°ria", "Campo Alegre", "Betol√¢ndia",
        "Aeroporto", "Novo Juazeiro", "Tiradentes", "Pedrinhas", "Brejo Seco"
    ];

    let orders = [];
    let activeRouteOrders = [];
    let charts = { prod: null, fat: null };
    let sortableInstance = null;

    // --- CONFIGURA√á√ÉO ---
    const DEFAULT_PRINT_CONFIG = { title: 'DIVINE PUDIM', subtitle: 'GOURMET', phone: '88 98824-4346', msg: 'Obrigado pela prefer√™ncia!', social: '@divinepudimgourmet', apiKey: '' };

    window.openPrintConfig = function() { 
        const cfg = JSON.parse(localStorage.getItem('printConfig')) || DEFAULT_PRINT_CONFIG; 
        if(document.getElementById('cfgTitle')) document.getElementById('cfgTitle').value = cfg.title; 
        if(document.getElementById('cfgSubtitle')) document.getElementById('cfgSubtitle').value = cfg.subtitle; 
        if(document.getElementById('cfgPhone')) document.getElementById('cfgPhone').value = cfg.phone; 
        if(document.getElementById('cfgMsg')) document.getElementById('cfgMsg').value = cfg.msg; 
        if(document.getElementById('cfgSocial')) document.getElementById('cfgSocial').value = cfg.social; 
        if(document.getElementById('cfgApiKey')) document.getElementById('cfgApiKey').value = cfg.apiKey || ''; 
        document.getElementById('printConfigModal').classList.add('active'); 
    };

    window.savePrintConfig = function() { 
        const cfg = { 
            title: document.getElementById('cfgTitle').value, 
            subtitle: document.getElementById('cfgSubtitle').value, 
            phone: document.getElementById('cfgPhone').value, 
            msg: document.getElementById('cfgMsg').value, 
            social: document.getElementById('cfgSocial').value,
            apiKey: document.getElementById('cfgApiKey') ? document.getElementById('cfgApiKey').value.trim() : ''
        }; 
        localStorage.setItem('printConfig', JSON.stringify(cfg)); 
        alert('Configura√ß√£o salva!'); 
        document.getElementById('printConfigModal').classList.remove('active'); 
    };

    window.resetPrintConfig = function() { 
        if(confirm('Restaurar padr√£o?')) { 
            localStorage.removeItem('printConfig'); 
            window.openPrintConfig(); 
        } 
    };

    // --- LOGIN ---
    window.handleLogin = function(e) {
        e.preventDefault();
        const u = document.getElementById('loginUser').value.toLowerCase().trim();
        const p = document.getElementById('loginPass').value;
        if(u === 'divinepudimgourmet' && p === '1810') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            initApp();
        } else { alert('Acesso negado.'); }
    };

    function initApp() {
        const bList = document.getElementById('cliBairro');
        if(bList.options.length <= 1) {
            BAIRROS.forEach(b => {
                let opt = document.createElement('option');
                opt.value = b; opt.textContent = b; bList.appendChild(opt);
            });
        }
        onSnapshot(query(colRef), (snapshot) => {
            orders = [];
            snapshot.forEach(doc => { let d = doc.data(); d.fbId = doc.id; orders.push(d); });
            orders.sort((a,b) => new Date(a.dataEntrega) - new Date(b.dataEntrega));
            orders.forEach((o, i) => o.displayId = (i + 1).toString().padStart(3, '0'));
            refreshAll();
        });
        document.getElementById('dataPed').valueAsDate = new Date();
    }

    // --- FUN√á√ïES GERAIS ---
    window.toggleAdiantamento = function() {
        const chk = document.getElementById('checkAdiantamento');
        const area = document.getElementById('areaAdiantamento');
        const lblRestante = document.getElementById('lblFormaRestante');
        const inpPago = document.getElementById('valPago');
        if(chk.checked) { area.style.display = 'grid'; lblRestante.innerText = "Forma de Pagamento (Do Restante)"; } 
        else { area.style.display = 'none'; inpPago.value = 0; lblRestante.innerText = "Forma de Pagamento (Valor Total)"; calcTotal(); }
    };

    window.addItem = function(data = null) {
        const id = Date.now() + Math.floor(Math.random() * 1000); 
        const html = `<div class="item-row" id="row-${id}"><div><select class="i-prod" onchange="updItem(${id})"><option value="">Selecione...</option>${PRODUTOS.map(p => `<option value="${p.nome}" ${p.requerSabor ? 'data-sabor="1"' : ''}>${p.nome}</option>`).join('')}<option value="OUTRO">Outro (Manual)</option></select><input type="text" class="i-cust" style="display:none; margin-top:5px; width:100%" placeholder="Digite aqui..."></div><div><select class="i-tam" onchange="updPrice(${id})"><option>-</option></select></div><div><input type="number" class="i-qtd" value="1" onchange="calcTotal()" style="width:60px"></div><div><input type="number" class="i-prc" step="0.01" onchange="calcTotal()" style="width:80px"></div><div class="i-total" style="font-weight:bold; color:#666">R$ 0,00</div><button type="button" class="btn btn-danger" onclick="this.parentElement.remove(); calcTotal()">X</button></div>`;
        document.getElementById('itemsContainer').insertAdjacentHTML('beforeend', html);
        if(data) {
            const row = document.getElementById(`row-${id}`); const selProd = row.querySelector('.i-prod'); const selTam = row.querySelector('.i-tam'); const inpCust = row.querySelector('.i-cust');
            let baseName = data.prod; let flavor = ''; const match = data.prod.match(/^(.*)\s\((.*)\)$/); if (match && PRODUTOS.find(p => p.nome === match[1])) { baseName = match[1]; flavor = match[2]; }
            const produtoObj = PRODUTOS.find(p => p.nome === baseName);
            if(produtoObj) { selProd.value = baseName; selTam.innerHTML = produtoObj.tamanhos.map(t => `<option value="${t.t}" data-p="${t.p}">${t.t}</option>`).join(''); selTam.value = data.tam; if(produtoObj.requerSabor) { inpCust.style.display = 'block'; inpCust.placeholder = "Sabor"; inpCust.value = flavor; } } 
            else { selProd.value = 'OUTRO'; inpCust.style.display = 'block'; inpCust.placeholder = "Produto"; inpCust.value = data.prod; selTam.innerHTML = `<option value="√önico">√önico</option>`; selTam.value = data.tam; }
            row.querySelector('.i-qtd').value = data.qtd; row.querySelector('.i-prc').value = data.prc; row.querySelector('.i-total').innerText = fmtMoeda(data.qtd * data.prc);
        }
    };

    window.updItem = function(id) { const row = document.getElementById(`row-${id}`); const sel = row.querySelector('.i-prod'); const tam = row.querySelector('.i-tam'); const cust = row.querySelector('.i-cust'); const prc = row.querySelector('.i-prc'); const opt = sel.options[sel.selectedIndex]; const val = sel.value; if(val === 'OUTRO') { cust.style.display = 'block'; cust.placeholder = "Produto"; tam.innerHTML = '<option value="√önico">√önico</option>'; prc.value = ''; } else { const p = PRODUTOS.find(x => x.nome === val); if(p) { tam.innerHTML = p.tamanhos.map(t => `<option value="${t.t}" data-p="${t.p}">${t.t}</option>`).join(''); if(p.tamanhos[0]) prc.value = p.tamanhos[0].p; } if (opt.getAttribute('data-sabor')) { cust.style.display = 'block'; cust.placeholder = "Sabor"; } else { cust.style.display = 'none'; cust.value = ''; } } calcTotal(); };
    window.updPrice = function(id) { const row = document.getElementById(`row-${id}`); const tam = row.querySelector('.i-tam'); const prc = row.querySelector('.i-prc'); const opt = tam.options[tam.selectedIndex]; if(opt && opt.dataset.p) { prc.value = opt.dataset.p; calcTotal(); } };
    window.quickUpdateStatus = async function(id, newStatus) { try { await updateDoc(doc(db, "pedidos", id), { status: newStatus }); } catch(e) {} };
    window.checkTipoEntrega = function() { const tipo = document.getElementById('tipoEntrega').value; const divDel = document.getElementById('deliveryFields'); const divRet = document.getElementById('retiradaFields'); if (tipo === 'Delivery') { divDel.style.display = 'block'; divRet.style.display = 'none'; document.getElementById('cliEnd').required = true; document.getElementById('cliBairro').required = true; document.getElementById('turnoEntrega').required = true; } else if (tipo === 'Retirada no local') { divDel.style.display = 'none'; divRet.style.display = 'block'; document.getElementById('cliEnd').required = false; document.getElementById('cliBairro').required = false; document.getElementById('turnoEntrega').required = false; } else { divDel.style.display = 'none'; divRet.style.display = 'none'; } };
    window.checkBairro = function() { const s = document.getElementById('cliBairro'); const i = document.getElementById('cliBairroOutro'); i.style.display = s.value === 'OUTRO' ? 'block' : 'none'; if(s.value === 'OUTRO') i.required = true; else i.required = false; };
    window.saveOrder = async function(e) { e.preventDefault(); let itens = []; document.querySelectorAll('.item-row').forEach(row => { const prodSel = row.querySelector('.i-prod').value; let prodNome = prodSel === 'OUTRO' ? row.querySelector('.i-cust').value : prodSel; const custField = row.querySelector('.i-cust'); if (custField.style.display !== 'none' && prodSel !== 'OUTRO') { prodNome += ` (${custField.value})`; } const qtd = parseFloat(row.querySelector('.i-qtd').value); const prc = parseFloat(row.querySelector('.i-prc').value); itens.push({ prod: prodNome, tam: row.querySelector('.i-tam').value, qtd: qtd, prc: prc }); }); const tipo = document.getElementById('tipoEntrega').value; let bairroFinal = '-'; let endFinal = '-'; let turnoFinal = '-'; let horarioRet = ''; if(tipo === 'Delivery') { const bairroSel = document.getElementById('cliBairro').value; bairroFinal = bairroSel === 'OUTRO' ? document.getElementById('cliBairroOutro').value : bairroSel; const num = document.getElementById('cliNumero').value; endFinal = document.getElementById('cliEnd').value + (num ? `, N¬∫ ${num}` : ''); turnoFinal = document.getElementById('turnoEntrega').value; } else { endFinal = 'Retirada na Loja'; horarioRet = document.getElementById('horarioRetirada').value; if(horarioRet) turnoFinal = `Retirada √†s ${horarioRet}`; else turnoFinal = 'Retirada'; } const taxa = parseFloat(document.getElementById('valTaxa').value) || 0; const pago = parseFloat(document.getElementById('valPago').value) || 0; const formaSinal = document.getElementById('formaPagSinal').value; const formaRestante = document.getElementById('formaPagRestante').value; let sumItens = itens.reduce((acc, i) => acc + (i.qtd * i.prc), 0); const totalFinal = sumItens + taxa; const restante = totalFinal - pago; const obj = { cliente: document.getElementById('cliNome').value, tel: document.getElementById('cliTel').value, cep: document.getElementById('cliCep').value, end: endFinal, bairro: bairroFinal, tipoEntrega: tipo, turno: turnoFinal, dataPedido: document.getElementById('dataPed').value, dataEntrega: document.getElementById('dataEnt').value, status: document.getElementById('statusPed').value, itens: itens, total: totalFinal, pago: pago, taxa: taxa, restante: restante, formaPagRestante: formaRestante, formaPagSinal: pago > 0 ? formaSinal : null, obs: document.getElementById('obs').value }; try { const editId = document.getElementById('editFirebaseId').value; if(editId) { await updateDoc(doc(db, "pedidos", editId), obj); alert('Atualizado!'); } else { await addDoc(colRef, obj); alert('Salvo!'); } closeOrderModal(); } catch(err) { console.error(err); alert('Erro ao salvar.'); } };
    window.editOrder = function(id) { const o = orders.find(x => x.fbId === id); if(!o) return; showNewOrderModal(); document.getElementById('editFirebaseId').value = id; document.getElementById('cliNome').value = o.cliente; document.getElementById('cliTel').value = o.tel; const isDelivery = o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada')); document.getElementById('tipoEntrega').value = isDelivery ? 'Delivery' : 'Retirada no local'; checkTipoEntrega(); if(isDelivery) { document.getElementById('cliCep').value = o.cep || ''; if(o.end && o.end.includes(', N¬∫')) { const parts = o.end.split(', N¬∫'); document.getElementById('cliEnd').value = parts[0].trim(); document.getElementById('cliNumero').value = parts[1].trim(); } else { document.getElementById('cliEnd').value = o.end; } const sel = document.getElementById('cliBairro'); let found = false; for(let i=0; i<sel.options.length; i++) { if(sel.options[i].value === o.bairro) { sel.selectedIndex = i; found = true; break; } } if(!found) { sel.value = 'OUTRO'; checkBairro(); document.getElementById('cliBairroOutro').value = o.bairro; } document.getElementById('turnoEntrega').value = (o.turno === 'Manh√£' || o.turno === 'Tarde') ? o.turno : ''; } else { if(o.turno.includes('√†s')) { document.getElementById('horarioRetirada').value = o.turno.split('√†s')[1].trim(); } } document.getElementById('dataPed').value = o.dataPedido; document.getElementById('dataEnt').value = o.dataEntrega; document.getElementById('statusPed').value = o.status; document.getElementById('valPago').value = o.pago; document.getElementById('valTaxa').value = o.taxa || 0; document.getElementById('formaPagRestante').value = o.formaPagRestante || ''; document.getElementById('obs').value = o.obs || ''; if(o.pago > 0) { document.getElementById('checkAdiantamento').checked = true; document.getElementById('areaAdiantamento').style.display = 'grid'; document.getElementById('formaPagSinal').value = o.formaPagSinal || ''; document.getElementById('lblFormaRestante').innerText = "Forma de Pagamento (Do Restante)"; } else { document.getElementById('checkAdiantamento').checked = false; document.getElementById('areaAdiantamento').style.display = 'none'; document.getElementById('lblFormaRestante').innerText = "Forma de Pagamento (Valor Total)"; } document.getElementById('itemsContainer').innerHTML = ''; o.itens.forEach(i => addItem(i)); calcTotal(); };
    window.calcTotal = function() { let itemsTotal = 0; document.querySelectorAll('.item-row').forEach(row => { const q = parseFloat(row.querySelector('.i-qtd').value) || 0; const p = parseFloat(row.querySelector('.i-prc').value) || 0; const sub = q * p; row.querySelector('.i-total').innerText = fmtMoeda(sub); itemsTotal += sub; }); const taxa = parseFloat(document.getElementById('valTaxa').value) || 0; const pago = parseFloat(document.getElementById('valPago').value) || 0; const finalTotal = itemsTotal + taxa; const divRestante = document.getElementById('divFormaRestante'); const valRestante = finalTotal - pago; if (valRestante <= 0.01) { divRestante.style.display = 'none'; } else { divRestante.style.display = 'block'; } document.getElementById('displayTotal').innerText = fmtMoeda(finalTotal); document.getElementById('valRest').value = fmtMoeda(valRestante); };

    // --- ROTAS (SORTABLEJS + API) ---
    window.renderRoutes = function() {
        const selectedTurno = document.getElementById('routeTurnoSelector').value;
        const listArea = document.getElementById('routeListArea');
        activeRouteOrders = orders.filter(o => {
            return (o.turno === selectedTurno || (o.turno && o.turno.includes(selectedTurno))) && 
                   o.status !== 'Entregue' && 
                   o.tipoEntrega === 'Delivery';
        });
        document.getElementById('routeCount').innerText = activeRouteOrders.length;
        document.getElementById('routeTurnoDisplay').innerText = selectedTurno;
        if(activeRouteOrders.length === 0) { listArea.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px">Nenhuma entrega pendente para este turno.</p>'; return; }
        listArea.innerHTML = activeRouteOrders.map((o, idx) => `<div class="route-item" data-fb-id="${o.fbId}"><div class="route-number">${idx + 1}</div><div class="route-details"><div class="route-addr">${o.end}</div><div class="route-bairro">${o.bairro}</div><div style="font-size:12px; color:#999">${o.cliente} (Ped #${o.displayId})</div></div><i class="fas fa-grip-lines route-handle"></i></div>`).join('');
        if (sortableInstance) { sortableInstance.destroy(); }
        sortableInstance = Sortable.create(listArea, {
            animation: 150, handle: '.route-item', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
            onEnd: function (evt) {
                const newOrderIds = Array.from(listArea.children).map(el => el.getAttribute('data-fb-id'));
                const newRouteArray = []; newOrderIds.forEach(id => { const found = activeRouteOrders.find(o => o.fbId === id); if(found) newRouteArray.push(found); }); activeRouteOrders = newRouteArray;
                Array.from(listArea.children).forEach((el, index) => { el.querySelector('.route-number').innerText = index + 1; });
            }
        });
    };

    window.autoSortRouteLogic = function() {
        if(activeRouteOrders.length === 0) return;
        activeRouteOrders.sort((a, b) => {
            const idxA = SEQUENCIA_LOGICA_BAIRROS.indexOf(a.bairro); const idxB = SEQUENCIA_LOGICA_BAIRROS.indexOf(b.bairro);
            const valA = idxA === -1 ? 999 : idxA; const valB = idxB === -1 ? 999 : idxB;
            return valA - valB;
        });
        renderRoutes(); alert('Rota organizada por sequ√™ncia l√≥gica de bairros!');
    };

    const START_COORDS = [-39.3175, -7.2270]; // Rua Apolo XI
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    window.optimizeRouteWithAI = async function() {
        // L√ìGICA DE API KEY H√çBRIDA (C√≥digo ou LocalStorage)
        const cfg = JSON.parse(localStorage.getItem('printConfig')) || DEFAULT_PRINT_CONFIG;
        let apiKey = cfg.apiKey;
        if (!apiKey || apiKey.trim() === '') { apiKey = API_KEY_FIXA; }

        if (!apiKey) { alert('Voc√™ precisa cadastrar uma API Key do OpenRouteService nas Configura√ß√µes!'); openPrintConfig(); return; }
        if (activeRouteOrders.length === 0) { alert('Nenhuma entrega para otimizar.'); return; }
        const loadingDiv = document.getElementById('apiLoading'); const loadingBar = document.getElementById('loadingBar'); const loadingText = document.getElementById('loadingText');
        loadingDiv.style.display = 'block'; loadingBar.style.width = '0%';
        try {
            const coords = [];
            for (let i = 0; i < activeRouteOrders.length; i++) {
                const order = activeRouteOrders[i];
                loadingText.innerText = `Lendo endere√ßo ${i+1}/${activeRouteOrders.length}: ${order.end}`;
                loadingBar.style.width = `${((i)/activeRouteOrders.length)*50}%`;
                // Remove caracteres especiais para evitar erros na URL
                const cleanEnd = order.end.replace(/[#]/g, '');
                const query = `${cleanEnd}, ${order.bairro}, Juazeiro do Norte, CE, Brazil`;
                
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                const res = await fetch(url); const data = await res.json();
                if (data && data.length > 0) { coords.push({ id: order.fbId, location: [parseFloat(data[0].lon), parseFloat(data[0].lat)] }); }
                await sleep(1100);
            }
            if (coords.length === 0) throw new Error("Nenhum endere√ßo foi localizado pelo GPS.");
            loadingText.innerText = "Calculando melhor rota..."; loadingBar.style.width = '75%';
            const jobs = coords.map(c => ({ id: c.id, location: c.location }));
            const vehicle = { id: 1, profile: 'driving-car', start: START_COORDS, end: START_COORDS };
            
            // USE PROXY PARA EVITAR ERRO DE CORS
            const proxyUrl = 'https://corsproxy.io/?';
            const targetUrl = 'https://api.openrouteservice.org/v2/optimization';
            
            const orsRes = await fetch(proxyUrl + encodeURIComponent(targetUrl), { 
                method: 'POST', 
                headers: { 'Authorization': apiKey, 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ jobs: jobs, vehicles: [vehicle] }) 
            });
            
            if (!orsRes.ok) throw new Error("Erro na API de Otimiza√ß√£o. Verifique sua chave.");
            const routeData = await orsRes.json();
            loadingText.innerText = "Reorganizando lista..."; loadingBar.style.width = '100%';
            if (routeData.routes && routeData.routes.length > 0) {
                const steps = routeData.routes[0].steps; const optimizedOrder = [];
                steps.forEach(step => { if (step.type === 'job') { const found = activeRouteOrders.find(o => o.fbId === step.id); if (found) optimizedOrder.push(found); } });
                activeRouteOrders.forEach(o => { if (!optimizedOrder.includes(o)) optimizedOrder.push(o); });
                activeRouteOrders = optimizedOrder; renderRoutes(); alert('Rota otimizada com sucesso via GPS!');
            }
        } catch (error) { console.error(error); alert('Erro ao otimizar: ' + error.message); } finally { loadingDiv.style.display = 'none'; }
    };

    window.openGoogleMapsRoute = function() {
        if(activeRouteOrders.length === 0) { alert('A rota est√° vazia.'); return; }
        let url = "https://www.google.com/maps/dir/Rua+Apolo+XI,+519,+Juazeiro+do+Norte+-+CE/";
        activeRouteOrders.forEach(o => { let cleanAddr = `${o.end}, ${o.bairro}, Juazeiro do Norte - CE`; url += encodeURIComponent(cleanAddr) + "/"; });
        window.open(url, '_blank');
    };

    // --- RENDER LISTA E PRINT ---
    window.renderOrdersList = function(list = orders) {
        const div = document.getElementById('ordersList');
        if(!list.length) { div.innerHTML = '<p style="grid-column:1/-1;text-align:center;padding:40px;color:#aaa">Nenhum pedido encontrado.</p>'; return; }
        const sorted = [...list].sort((a,b) => new Date(a.dataEntrega) - new Date(b.dataEntrega));
        div.innerHTML = sorted.map((o, index) => {
            const numPedido = o.displayId; 
            const statusMap = { 'Pedido confirmado': 'card-confirmado', 'Produzindo': 'card-produzindo', 'Pronto': 'card-pronto', 'Em rota': 'card-rota', 'Entregue': 'card-entregue' };
            const statusClass = statusMap[o.status] || 'card-confirmado';
            const colorMap = { 'Pedido confirmado': '#000000', 'Produzindo': '#facc15', 'Pronto': '#3b82f6', 'Em rota': '#a855f7', 'Entregue': '#22c55e' };
            const selectBg = colorMap[o.status] || '#000000'; const selectColor = o.status === 'Produzindo' ? '#000000' : '#ffffff';
            const itensHtml = o.itens.map(i => `<div class="item-line"><span>${i.qtd}x ${i.prod} (${i.tam})</span> <span>${fmtMoeda(i.prc*i.qtd)}</span></div>`).join('');
            let endInfo = o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada')) ? `<i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${o.end}, ${o.bairro}` : `<i class="fas fa-store" style="color:var(--primary)"></i> Retirada na Loja`;
            const opts = ['Pedido confirmado','Produzindo','Pronto','Em rota','Entregue'].map(s => `<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join('');
            let pagInfo = o.restante <= 0.01 ? `<div class="payment-highlight" style="background:#dcfce7; color:#166534; border-color:#bbf7d0"><span>STATUS:</span> <span>PAGO TOTAL</span></div>` : (o.pago > 0 ? `<div class="payment-highlight"><span>Restante:</span> <span>${o.formaPagRestante || '?'}</span></div>` : `<div class="payment-highlight"><span>Total:</span> <span>${o.formaPagRestante || '?'}</span></div>`);
            return `<div class="order-card ${statusClass}"><div class="order-header"><div><div class="order-id">#${numPedido}</div><div class="order-date">${fmtData(o.dataEntrega)} ‚Ä¢ ${o.turno}</div></div><select class="status-select" onchange="quickUpdateStatus('${o.fbId}', this.value)" style="background:${selectBg}; color:${selectColor}">${opts}</select></div><div class="order-body"><div class="client-info"><span class="client-name">${o.cliente}</span><div class="client-detail"><i class="fas fa-phone" style="font-size:11px"></i> ${o.tel}</div><div class="client-detail">${endInfo}</div>${o.obs ? `<div class="client-detail" style="color:#e11d48;font-style:italic"><i class="fas fa-comment"></i> ${o.obs}</div>` : ''}</div><div class="items-box">${itensHtml}</div>${pagInfo}<div class="finance-box">${o.pago > 0 ? `<div class="finance-row"><span>Pago (Sinal):</span> <span style="color:#10b981">${fmtMoeda(o.pago)}</span></div>` : ''}<div class="finance-total" style="display:flex;justify-content:space-between;color:${o.restante>0?'#ef4444':'#10b981'}"><span>A PAGAR:</span> <span>${fmtMoeda(o.restante)}</span></div></div></div><div class="order-footer"><button class="btn btn-card" onclick="editOrder('${o.fbId}')"><i class="fas fa-edit"></i> Editar</button><button class="btn btn-card" onclick="printOrder('${o.fbId}', '${numPedido}')"><i class="fas fa-print"></i> Cupom</button><button class="btn btn-card" onclick="deleteOrder('${o.fbId}')" style="color:#ef4444"><i class="fas fa-trash"></i></button></div></div>`;
        }).join('');
    };

    window.printOrder = function(id, numPedido) {
        const o = orders.find(x => x.fbId === id);
        const cfg = JSON.parse(localStorage.getItem('printConfig')) || DEFAULT_PRINT_CONFIG;
        const w = window.open('', '', 'width=300,height=600');
        let headerEnd = ""; let bodyEnd = "";
        if (o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada'))) { headerEnd = "DELIVERY"; bodyEnd = `<div class="destaque">ENDERE√áO:</div><div class="big">${o.end || ''}</div><div class="big">${o.bairro || ''}</div>${o.obs ? `<div style="margin-top:5px; border:1px solid #000; padding:2px"><b>OBS:</b> ${o.obs}</div>` : ''}`; } 
        else { headerEnd = "RETIRADA"; bodyEnd = `<div class="center big" style="border:2px solid #000; padding:5px; margin:5px 0;">CLIENTE VAI RETIRAR</div>`; }
        let paymentBox = o.restante <= 0.01 ? `<div class="box-pagamento">PAGO TOTAL</div>` : (o.pago > 0 ? `<div class="box-pagamento">RESTANTE: ${fmtMoeda(o.restante)}<br><small>(${o.formaPagRestante || '?'})</small></div>` : `<div class="box-pagamento">A PAGAR: ${fmtMoeda(o.total)}<br><small>(${o.formaPagRestante || '?'})</small></div>`);
        w.document.write(`<html><head><style>@page { margin: 0; size: auto; } body { margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; font-size: 12px; width: 48mm; color: #000; margin-right: 2mm; } .container { padding: 2px 2px 20px 2px; overflow-x: hidden; } * { font-weight: bold; line-height: 1.1; word-wrap: break-word; } .center { text-align: center; } .row { display: flex; justify-content: space-between; } .big { font-size: 14px; } .giant { font-size: 16px; text-transform: uppercase; } .line { border-bottom: 2px dashed #000; margin: 5px 0; } .destaque { font-size: 11px; text-transform: uppercase; margin-top: 5px; } .item-row { margin-bottom: 4px; padding-bottom: 2px; border-bottom: 1px dotted #ccc; } .box-pagamento { border: 2px solid #000; padding: 5px; margin-top: 10px; text-align: center; font-size: 14px; border-radius: 5px; background: #eee !important; -webkit-print-color-adjust: exact; } </style></head><body><div class="container"><div class="center giant">${cfg.title}</div><div class="center" style="font-size:11px">${cfg.subtitle}</div><div class="center" style="margin-bottom:5px">${cfg.phone}</div><div class="line"></div><div class="row big"><span>PEDIDO</span><span>#${numPedido}</span></div><div class="center giant" style="margin:5px 0; background:#000; color:#fff; -webkit-print-color-adjust: exact;">${headerEnd}</div><div class="center">${fmtData(o.dataEntrega)}</div><div class="center">${o.turno}</div><div class="line"></div><div class="destaque">CLIENTE:</div><div class="big">${o.cliente}</div><div>${o.tel}</div><div class="line"></div>${bodyEnd}<div class="line"></div><div class="destaque" style="margin-bottom:5px">ITENS:</div>${o.itens.map(i => `<div class="item-row"><div style="font-size:13px">${i.qtd}x ${i.prod}</div><div class="row"><span style="font-size:10px; font-weight:normal">${i.tam}</span><span>${fmtMoeda(i.prc * i.qtd)}</span></div></div>`).join('')}<div class="line"></div><div class="row" style="font-size:11px"><span>Taxa:</span><span>${fmtMoeda(o.taxa)}</span></div><div class="row" style="font-size:11px"><span>Sinal:</span><span>${fmtMoeda(o.pago)}</span></div><div class="row giant" style="margin-top:5px"><span>TOTAL:</span><span>${fmtMoeda(o.total)}</span></div>${paymentBox}<div class="center" style="margin-top:15px; font-size:10px;">${cfg.msg} <br>${cfg.social}</div><br>.</div></body></html>`);
        setTimeout(() => { w.document.close(); w.print(); w.close(); }, 500);
    };

    // --- RESTANTE ---
    window.buscarCep = async function() { let cep = document.getElementById('cliCep').value.replace(/\D/g,''); if(cep.length === 8) { try { let r = await fetch(`https://viacep.com.br/ws/${cep}/json/`); let d = await r.json(); if(!d.erro) { document.getElementById('cliEnd').value = d.logradouro; const bSelect = document.getElementById('cliBairro'); let found = false; for (let i = 0; i < bSelect.options.length; i++) { if (bSelect.options[i].value.toLowerCase() === d.bairro.toLowerCase()) { bSelect.selectedIndex = i; found = true; break; } } if (!found) { bSelect.value = 'OUTRO'; document.getElementById('cliBairroOutro').value = d.bairro; } checkBairro(); } } catch(e) {} } };
    window.showNewOrderModal = function() { document.getElementById('orderForm').reset(); document.getElementById('itemsContainer').innerHTML = ''; document.getElementById('editFirebaseId').value = ''; document.getElementById('dataPed').valueAsDate = new Date(); document.getElementById('checkAdiantamento').checked = false; toggleAdiantamento(); document.getElementById('orderModal').classList.add('active'); checkTipoEntrega(); addItem(); };
    window.closeOrderModal = function() { document.getElementById('orderModal').classList.remove('active'); };
    window.deleteOrder = async function(id) { if(confirm('Excluir?')) await deleteDoc(doc(db, "pedidos", id)); };
    window.fmtMoeda = v => v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    window.fmtData = d => d.split('-').reverse().join('/');
    window.searchOrders = function() { applyFilters(); };
    window.clearFilters = function() { document.getElementById('searchInput').value = ''; document.getElementById('filterData').value = ''; document.getElementById('filterBairro').value = ''; document.getElementById('filterStatus').value = ''; document.getElementById('filterTipo').value = ''; document.getElementById('filterTurno').value = ''; applyFilters(); };
    window.showTab = function(e, tabId) { if(e) e.preventDefault(); document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active'); if(e && e.target) e.target.closest('.tab-btn').classList.add('active'); if(tabId === 'graficos') window.renderCharts(); if(tabId === 'rotas') window.renderRoutes(); };
    window.refreshAll = function() { renderDashboard(); renderOrdersList(); populateBairroFilter(); if(document.getElementById('tabRotas').classList.contains('active')) renderRoutes(); };
    window.applyFilters = function() { const term = document.getElementById('searchInput').value.toLowerCase(); const date = document.getElementById('filterData').value; const bairro = document.getElementById('filterBairro').value; const status = document.getElementById('filterStatus').value; const tipo = document.getElementById('filterTipo').value; const turno = document.getElementById('filterTurno').value; const filtered = orders.filter(o => { let ok = true; if(term && !o.cliente.toLowerCase().includes(term)) ok = false; if(date && o.dataEntrega !== date) ok = false; if(bairro && o.bairro !== bairro) ok = false; if(status && o.status !== status) ok = false; if(tipo && tipo !== 'Todos' && o.tipoEntrega !== tipo) ok = false; if(turno && turno !== 'Todos' && o.turno !== turno && !o.turno.includes(turno)) ok = false; return ok; }); renderOrdersList(filtered); };
    window.exportProductSummary = function() {
        const term = document.getElementById('searchInput').value.toLowerCase(); const date = document.getElementById('filterData').value; const bairro = document.getElementById('filterBairro').value; const statusFilter = document.getElementById('filterStatus').value; const tipo = document.getElementById('filterTipo').value; const turno = document.getElementById('filterTurno').value;
        const filtered = orders.filter(o => { let ok = true; if(term && !o.cliente.toLowerCase().includes(term)) ok = false; if(date && o.dataEntrega !== date) ok = false; if(bairro && o.bairro !== bairro) ok = false; if(statusFilter && o.status !== statusFilter) ok = false; if(tipo && tipo !== 'Todos' && o.tipoEntrega !== tipo) ok = false; if(turno && turno !== 'Todos' && o.turno !== turno && !o.turno.includes(turno)) ok = false; return ok; });
        if (filtered.length === 0) { alert("Nenhum pedido encontrado com os filtros atuais."); return; }
        const toProduce = {}; const produced = {}; let hasData = false;
        filtered.forEach(o => { let targetMap = null; if (o.status === 'Pedido confirmado' || o.status === 'Produzindo') { targetMap = toProduce; } else if (o.status === 'Pronto') { targetMap = produced; } if (targetMap) { hasData = true; o.itens.forEach(i => { let key = `${i.prod} (${i.tam})`; if (!targetMap[key]) targetMap[key] = 0; targetMap[key] += i.qtd; }); } });
        if (!hasData) { alert("Nenhum pedido para produzir ou pronto encontrado (ignorando rota/entregue)."); return; }
        const rowsToProduce = Object.keys(toProduce).sort().map(k => [k, toProduce[k]]); const rowsProduced = Object.keys(produced).sort().map(k => [k, produced[k]]);
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(18); doc.text("Resumo de Produ√ß√£o", 14, 20); doc.setFontSize(10); let filterText = date ? `Data: ${fmtData(date)}` : "Todos os pedidos listados (Filtro Atual)"; doc.text(filterText, 14, 28);
        let currentY = 35;
        if (rowsToProduce.length > 0) { doc.setFontSize(14); doc.setTextColor(220, 38, 38); doc.text("FALTA PRODUZIR (Confirmados/Produzindo)", 14, currentY); currentY += 5; doc.autoTable({ head: [["Produto (Tamanho)", "Quantidade"]], body: rowsToProduce, startY: currentY, theme: 'grid', headStyles: { fillColor: [220, 38, 38] }, columnStyles: { 0: { cellWidth: 140 }, 1: { cellWidth: 40, halign: 'center', fontStyle: 'bold' } } }); currentY = doc.lastAutoTable.finalY + 15; }
        if (rowsProduced.length > 0) { doc.setFontSize(14); doc.setTextColor(22, 163, 74); doc.text("J√Å PRODUZIDOS (Prontos no Balc√£o/Freezer)", 14, currentY); currentY += 5; doc.autoTable({ head: [["Produto (Tamanho)", "Quantidade"]], body: rowsProduced, startY: currentY, theme: 'grid', headStyles: { fillColor: [22, 163, 74] }, columnStyles: { 0: { cellWidth: 140 }, 1: { cellWidth: 40, halign: 'center', fontStyle: 'bold' } } }); }
        doc.save(`Resumo_Producao_Separado_${new Date().toISOString().split('T')[0]}.pdf`);
    };
    window.populateBairroFilter = function() { const b = [...new Set(orders.map(o => o.bairro))].sort(); document.getElementById('filterBairro').innerHTML = '<option value="">Todos</option>' + b.map(x => `<option>${x}</option>`).join(''); };
    window.exportBackup = function() { const b = new Blob([JSON.stringify(orders)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup.json'; a.click(); };
    window.handleImport = function(e) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (ev) => { try { const arr = JSON.parse(ev.target.result); if(confirm(`Importar ${arr.length} pedidos?`)) { for(let o of arr) { delete o.fbId; await addDoc(colRef, o); } alert('Conclu√≠do!'); } } catch(x) { alert('Erro arquivo invalido'); } }; r.readAsText(f); };
    window.exportToPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); doc.setFontSize(18); doc.text("Relat√≥rio de Pedidos - Divine Pudim Gourmet", 14, 20); doc.setFontSize(10); doc.text("Gerado em: " + new Date().toLocaleString(), 14, 28); const tableColumn = ["Entregue Em", "Cliente/Contato", "Endere√ßo Completo", "Itens", "Total", "Pago", "Falta"]; const tableRows = []; orders.sort((a,b) => new Date(a.dataEntrega) - new Date(b.dataEntrega)).forEach(o => { const itemsStr = o.itens.map(i => `${i.qtd}x ${i.prod} (${i.tam})`).join('\n'); const endStr = o.tipoEntrega === 'Retirada no local' ? 'RETIRADA' : `${o.end}\n${o.bairro}\nObs: ${o.obs || '-'}`; tableRows.push([`${fmtData(o.dataEntrega)}\n${o.turno}`, `${o.cliente}\n${o.tel}`, endStr, itemsStr, fmtMoeda(o.total), fmtMoeda(o.pago), fmtMoeda(o.restante)]); }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, theme: 'grid', styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' }, columnStyles: { 0: {cellWidth:25}, 1:{cellWidth:35}, 2:{cellWidth:60}, 3:{cellWidth:70}, 4:{cellWidth:20, halign:'right'}, 5:{cellWidth:20, halign:'right'}, 6:{cellWidth:20, halign:'right'} } }); doc.save(`Relatorio_${new Date().toISOString().split('T')[0]}.pdf`); };
    window.exportToExcel = function() { const wb = XLSX.utils.book_new(); const data = orders.map(o => ({ "Data Entrega": fmtData(o.dataEntrega), "Tipo": o.tipoEntrega, "Turno": o.turno, "Status": o.status, "Cliente": o.cliente, "Telefone": o.tel, "Endere√ßo": o.end, "Bairro": o.bairro, "Obs": o.obs, "Itens": o.itens.map(i => `${i.qtd}x ${i.prod}`).join('; '), "Total": o.total, "Pago": o.pago, "Restante": o.restante })); const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch:12}, {wch:15}, {wch:15}, {wch:15}, {wch:25}, {wch:15}, {wch:40}, {wch:15}, {wch:20}, {wch:50}]; XLSX.utils.book_append_sheet(wb, ws, "Pedidos"); XLSX.writeFile(wb, `Relatorio_${new Date().toISOString().split('T')[0]}.xlsx`); };
    window.renderCharts = function() { const ctxProd = document.getElementById('chartProd'); const ctxFat = document.getElementById('chartFat'); if(charts.prod) charts.prod.destroy(); if(charts.fat) charts.fat.destroy(); const counts = {}; orders.forEach(o => o.itens.forEach(i => { let key = `${i.prod} (${i.tam})`; counts[key] = (counts[key] || 0) + i.qtd; })); charts.prod = new Chart(ctxProd, { type: 'bar', data: { labels: Object.keys(counts), datasets: [{ label: 'Qtd', data: Object.values(counts), backgroundColor: '#ec4899' }] }, options: { responsive: true, maintainAspectRatio: false } }); const statusFat = {}; orders.forEach(o => statusFat[o.status] = (statusFat[o.status] || 0) + o.total); charts.fat = new Chart(ctxFat, { type: 'doughnut', data: { labels: Object.keys(statusFat), datasets: [{ data: Object.values(statusFat), backgroundColor: ['#3b82f6','#f59e0b','#8b5cf6','#06b6d4','#10b981'] }] }, options: { responsive: true, maintainAspectRatio: false } }); };
    window.renderDashboard = function() { document.getElementById('dashTotal').innerText = orders.length; const fat = orders.reduce((acc, o) => acc + (o.total || 0), 0); const recebido = orders.reduce((acc, o) => acc + (o.pago || 0), 0); const taxas = orders.reduce((acc, o) => acc + (o.taxa || 0), 0); const aReceber = orders.reduce((acc, o) => acc + (o.restante || 0), 0); document.getElementById('dashFaturado').innerText = fmtMoeda(fat); document.getElementById('dashRecebido').innerText = fmtMoeda(recebido); document.getElementById('dashTaxas').innerText = fmtMoeda(taxas); document.getElementById('dashReceber').innerText = fmtMoeda(aReceber); const counts = {}; orders.forEach(o => o.itens.forEach(i => { let key = `${i.prod} - ${i.tam}`; counts[key] = (counts[key] || 0) + i.qtd; })); const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]); document.getElementById('topProductsList').innerHTML = sorted.map(([k,v]) => `<div style="background:#f9f9f9; padding:12px; border-radius:8px; display:flex; justify-content:space-between; border-left:4px solid var(--primary)"><b>${k}</b><span style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:12px">${v} un</span></div>`).join('');
    if(document.getElementById('dashProduzindo')) document.getElementById('dashProduzindo').innerText = orders.filter(o => o.status === 'Produzindo').length;
    if(document.getElementById('dashPronto')) document.getElementById('dashPronto').innerText = orders.filter(o => o.status === 'Pronto').length;
    if(document.getElementById('dashRota')) document.getElementById('dashRota').innerText = orders.filter(o => o.status === 'Em rota').length;
    if(document.getElementById('dashEntregue')) document.getElementById('dashEntregue').innerText = orders.filter(o => o.status === 'Entregue').length;
    };
</script>
</body>
</html>
