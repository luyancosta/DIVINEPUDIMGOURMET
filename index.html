<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divine Pudim Gourmet - Sistema V8</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* ================= ESTILOS GERAIS (VOLTA AO VISUAL V6) ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #ec4899; --primary-dark: #be185d; --primary-light: #fdf2f8;
            --accent: #ffd700; --white: #ffffff;
            --gray-50: #fafafa; --gray-100: #f5f5f5; --gray-200: #e5e5e5;
            --gray-600: #525252; --gray-800: #262626;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --transition: all 0.3s ease;
        }
        /* Fundo Rosa Original */
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%); color: var(--gray-800); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        /* LOGIN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary); }
        .btn-login { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-login:hover { background: var(--primary-dark); transform: translateY(-2px); }

        /* APP HEADER (Estilo V6) */
        #appContent { display: none; padding-bottom: 40px; }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--white); padding: 20px 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .logo { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--accent); font-size: 28px; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* BOTÕES */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: var(--transition); }
        .btn-header { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-header:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: var(--accent); color: var(--gray-800); font-weight: 700; box-shadow: var(--shadow); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-800); }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        
        /* TABS */
        .tabs-nav { background: var(--white); padding: 10px 0; position: sticky; top: 70px; z-index: 990; box-shadow: var(--shadow); margin-bottom: 20px; overflow-x: auto; }
        .tabs-buttons { display: flex; gap: 10px; padding: 0 20px; min-width: max-content; }
        .tab-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; color: var(--gray-600); font-weight: 600; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--primary-light); border-radius: 8px 8px 0 0; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS GERAIS */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: center; }
        .card-row { display: flex; align-items: center; gap: 15px; }
        .card-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; flex-shrink: 0; }
        .card h3 { font-size: 20px; font-weight: 700; margin-bottom: 5px; }

        /* PEDIDOS E FILTROS */
        .search-bar, .filters { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-family: inherit; }
        
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }

        /* ================= ESTILO DO CARD DO PEDIDO (V7 EM DIANTE) ================= */
        .order-card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); /* Sombra suave */
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            position: relative;
            transition: transform 0.2s;
        }
        .order-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* Faixa lateral de status */
        .order-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: var(--card-color, var(--primary)); 
        }

        .order-header { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .order-id { font-weight: 800; font-size: 16px; color: var(--gray-800); }
        .order-date { font-size: 12px; color: var(--gray-600); }
        
        .order-body { padding: 15px; flex: 1; }
        
        .client-info { margin-bottom: 12px; }
        .client-name { font-weight: 700; font-size: 15px; display: block; margin-bottom: 2px; color:#333; }
        .client-detail { font-size: 13px; color: #666; display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        
        .items-box { background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 10px 0; border: 1px dashed #ddd; }
        .item-line { font-size: 13px; margin-bottom: 4px; display: flex; justify-content: space-between; color:#444; }
        
        .finance-box { margin-top: 10px; font-size: 13px; }
        .finance-row { display: flex; justify-content: space-between; margin-bottom: 3px; color: #666; }
        .finance-total { font-weight: 800; font-size: 15px; color: var(--gray-800); margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
        
        .status-select { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: bold; border: 1px solid #ddd; cursor: pointer; outline: none; }
        
        .order-footer { padding: 12px 15px; background: #fafafa; border-top: 1px solid #f0f0f0; display: flex; gap: 8px; }
        .btn-card { flex: 1; justify-content: center; background: white; border: 1px solid #ddd; font-size: 12px; color: #555; padding:8px; border-radius:6px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:5px; }
        .btn-card:hover { background: var(--primary-light); color: var(--primary-dark); border-color: var(--primary-light); }

        /* STATUS COLORS VARIABLES */
        .card-confirmado { --card-color: #3b82f6; }
        .card-produzindo { --card-color: #f59e0b; }
        .card-pronto { --card-color: #8b5cf6; }
        .card-rota { --card-color: #06b6d4; }
        .card-entregue { --card-color: #10b981; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 950px; max-height: 90vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-body { padding: 30px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        .items-header { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap: 10px; font-weight: bold; color: var(--gray-600); margin-bottom: 5px; font-size: 14px; padding: 0 10px; }
        .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fff; }
        .input-group { position: relative; }
        .input-group span { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-weight: bold; color: #666; }
        .input-group input { padding-left: 35px; }

        @media(max-width: 768px) {
            .items-header { display: none; }
            .item-row { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; }
        }
        @media print { body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 58mm; padding: 0; margin: 0; font-size: 12px; font-family: monospace; } }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <div class="login-logo"><i class="fas fa-birthday-cake"></i></div>
        <h2 style="margin-bottom:20px; color:var(--gray-800)">Divine Pudim Gourmet</h2>
        <form onsubmit="handleLogin(event)">
            <input type="text" id="loginUser" class="login-input" placeholder="Usuário" required>
            <input type="password" id="loginPass" class="login-input" placeholder="Senha" required>
            <button type="submit" class="btn-login">Entrar</button>
        </form>
    </div>
</div>

<div id="appContent">
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo"><i class="fas fa-birthday-cake"></i> Divine Pudim Gourmet</div>
                <div class="header-actions">
                    <button class="btn btn-header" onclick="exportBackup()">Backup</button>
                    <button class="btn btn-header" onclick="document.getElementById('importInput').click()">Importar</button>
                    <button class="btn btn-primary" onclick="showNewOrderModal()">+ Novo Pedido</button>
                    <button class="btn btn-danger" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </header>

    <div id="alertsArea"></div>

    <nav class="tabs-nav">
        <div class="container">
            <div class="tabs-buttons">
                <button class="tab-btn active" onclick="showTab(event, 'dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
                <button class="tab-btn" onclick="showTab(event, 'pedidos')"><i class="fas fa-list"></i> Pedidos</button>
                <button class="tab-btn" onclick="showTab(event, 'graficos')"><i class="fas fa-chart-pie"></i> Gráficos</button>
            </div>
        </div>
    </nav>

    <section id="tabDashboard" class="tab-content active">
        <div class="container">
            <div class="dashboard-grid">
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#ec4899"><i class="fas fa-shopping-bag"></i></div><div><h3 id="dashTotal">0</h3><p>Total Pedidos</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#8b5cf6"><i class="fas fa-dollar-sign"></i></div><div><h3 id="dashFaturado">R$ 0,00</h3><p>Total Faturado</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#10b981"><i class="fas fa-check-double"></i></div><div><h3 id="dashRecebido">R$ 0,00</h3><p>Valor Recebido</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#f59e0b"><i class="fas fa-hand-holding-usd"></i></div><div><h3 id="dashReceber">R$ 0,00</h3><p>A Receber</p></div></div></div>
                <div class="card"><div class="card-row"><div class="card-icon" style="background:#06b6d4"><i class="fas fa-motorcycle"></i></div><div><h3 id="dashTaxas">R$ 0,00</h3><p>Taxas Entrega</p></div></div></div>
            </div>
            <div class="card" style="display: block;">
                <h3 style="border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 15px;"><i class="fas fa-box-open"></i> Quantidade de produtos pedidos</h3>
                <div id="topProductsList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px;"></div>
            </div>
        </div>
    </section>

    <section id="tabPedidos" class="tab-content">
        <div class="container">
            <div class="search-bar"><input type="text" id="searchInput" placeholder="Buscar cliente..." oninput="searchOrders()"></div>
            <div class="filters">
                <div class="filters-grid">
                    <div><label>Data</label><input type="date" id="filterData" onchange="applyFilters()"></div>
                    <div><label>Bairro</label><select id="filterBairro" onchange="applyFilters()"><option value="">Todos</option></select></div>
                    <div><label>Tipo Entrega</label>
                        <select id="filterTipo" onchange="applyFilters()">
                            <option value="">Todos</option>
                            <option value="Delivery">Delivery</option>
                            <option value="Retirada no local">Retirada</option>
                        </select>
                    </div>
                    <div><label>Turno</label>
                        <select id="filterTurno" onchange="applyFilters()">
                            <option value="">Todos</option>
                            <option value="Manhã">Manhã</option>
                            <option value="Tarde">Tarde</option>
                        </select>
                    </div>
                    <div><label>Status</label><select id="filterStatus" onchange="applyFilters()">
                        <option value="">Todos</option>
                        <option value="Pedido confirmado">Confirmado</option>
                        <option value="Produzindo">Produzindo</option>
                        <option value="Pronto">Pronto</option>
                        <option value="Em rota">Em rota</option>
                        <option value="Entregue">Entregue</option>
                    </select></div>
                    <div style="display:flex; align-items:end;"><button class="btn btn-secondary" onclick="clearFilters()" style="width:100%">Limpar</button></div>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
                    <button class="btn btn-secondary" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Baixar Excel</button>
                </div>
            </div>
            <div id="ordersList" class="orders-grid"></div>
        </div>
    </section>

    <section id="tabGraficos" class="tab-content">
        <div class="container">
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                <div class="card" style="display:block; min-height:350px"><h3>Produtos</h3><div style="height:300px; position:relative;"><canvas id="chartProd"></canvas></div></div>
                <div class="card" style="display:block; min-height:350px"><h3>Faturamento</h3><div style="height:300px; position:relative;"><canvas id="chartFat"></canvas></div></div>
            </div>
        </div>
    </section>
</div>

<div id="orderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Novo Pedido</h2>
            <button onclick="closeOrderModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer">&times;</button>
        </div>
        <form id="orderForm" onsubmit="saveOrder(event)">
            <div class="modal-body">
                <div class="form-row">
                    <div><label>Nome *</label><input type="text" id="cliNome" required></div>
                    <div><label>WhatsApp *</label><input type="tel" id="cliTel" required></div>
                    <div><label>Forma de Entrega *</label>
                        <select id="tipoEntrega" onchange="checkTipoEntrega()" required>
                            <option value="">Selecione</option>
                            <option value="Delivery">Delivery</option>
                            <option value="Retirada no local">Retirada no local</option>
                        </select>
                    </div>
                </div>

                <div id="deliveryFields" style="display:none; background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                    <h4 style="margin-bottom:10px; color:var(--primary)">Dados de Entrega</h4>
                    <div class="form-row">
                        <div><label>CEP</label><div style="display:flex; gap:5px"><input type="text" id="cliCep" onblur="buscarCep()"><button type="button" class="btn btn-secondary" onclick="buscarCep()"><i class="fas fa-search"></i></button></div></div>
                        <div style="grid-column: span 1"><label>Endereço *</label><input type="text" id="cliEnd"></div>
                        <div><label>Número (Nº)</label><input type="text" id="cliNumero"></div>
                    </div>
                    <div class="form-row">
                        <div><label>Bairro *</label><select id="cliBairro" onchange="checkBairro()"><option value="">Selecione</option></select><input type="text" id="cliBairroOutro" style="display:none; margin-top:5px" placeholder="Digite o bairro"></div>
                        <div><label>Turno da Entrega *</label>
                            <select id="turnoEntrega">
                                <option value="">Selecione</option>
                                <option value="Manhã">Manhã</option>
                                <option value="Tarde">Tarde</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="retiradaFields" style="display:none; background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                    <h4 style="margin-bottom:10px; color:var(--primary)">Dados de Retirada</h4>
                    <div class="form-row">
                        <div><label>Horário da Retirada (Opcional)</label><input type="time" id="horarioRetirada"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div><label>Data Pedido</label><input type="date" id="dataPed" required></div>
                    <div><label>Data Entrega</label><input type="date" id="dataEnt" required></div>
                    <div><label>Status</label>
                        <select id="statusPed">
                            <option value="Pedido confirmado">Confirmado</option>
                            <option value="Produzindo">Produzindo</option>
                            <option value="Pronto">Pronto</option>
                            <option value="Em rota">Em rota</option>
                            <option value="Entregue">Entregue</option>
                        </select>
                    </div>
                </div>

                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee">
                <h3>Itens</h3>
                <div class="items-header"><div>Produto</div><div>Tamanho</div><div>Qtd</div><div>V. Unit</div><div>V. Total</div><div></div></div>
                <div id="itemsContainer"></div>
                <button type="button" class="btn btn-primary" onclick="addItem()" style="width:100%; margin-top:10px">+ Adicionar Item</button>
                <div style="text-align:right; font-size:18px; font-weight:bold; margin-top:15px; color:var(--primary-dark)">Total: <span id="displayTotal">R$ 0,00</span></div>

                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee">
                
                <h3 style="margin-bottom:15px; color:var(--gray-800)">Pagamento</h3>
                
                <div style="margin-bottom:15px; background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:bold; font-size:14px; color:#0369a1">
                        <input type="checkbox" id="checkAdiantamento" onchange="toggleAdiantamento()" style="width:18px; height:18px">
                        Recebeu valor antecipado (Sinal)?
                    </label>
                </div>

                <div class="form-row">
                    <div id="areaAdiantamento" style="display:none; grid-template-columns: 1fr 1fr; gap:15px; grid-column: span 2; background:#f0fdf4; padding:10px; border-radius:8px; border:1px solid #bbf7d0">
                        <div><label style="color:#166534">Valor Pago (Sinal)</label><div class="input-group"><span>R$</span><input type="number" step="0.01" id="valPago" oninput="calcTotal()"></div></div>
                        <div><label style="color:#166534">Forma Pagto (Sinal)</label>
                            <select id="formaPagSinal">
                                <option value="">Selecione</option>
                                <option value="Pix">Pix</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cartão">Cartão</option>
                            </select>
                        </div>
                    </div>

                    <div style="grid-column: span 2">
                        <label id="lblFormaRestante">Forma de Pagamento (Valor Total)</label>
                        <select id="formaPagRestante">
                            <option value="">Selecione a forma de pagamento...</option>
                            <option value="Pix">Pix</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão">Cartão</option>
                        </select>
                    </div>

                    <div><label>Taxa Entrega</label><div class="input-group"><span>R$</span><input type="number" step="0.01" id="valTaxa" oninput="calcTotal()"></div></div>
                    <div><label>Restante a Pagar</label><div class="input-group"><span>R$</span><input type="text" id="valRest" readonly style="font-weight:bold; color:red"></div></div>
                </div>
                
                <div style="margin-top:10px"><label>Observação</label><textarea id="obs" rows="2"></textarea></div>

                <input type="hidden" id="editFirebaseId">
                <div style="margin-top:30px; display:flex; justify-content:flex-end; gap:10px">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Pedido</button>
                </div>
            </div>
        </form>
    </div>
</div>

<input type="file" id="importInput" style="display:none" onchange="handleImport(event)" accept=".json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBt_7_WLXqUvYqdCrTMQg7ySZUa4gSdEHY",
      authDomain: "divinepudimsystem.firebaseapp.com",
      projectId: "divinepudimsystem",
      storageBucket: "divinepudimsystem.firebasestorage.app",
      messagingSenderId: "529626240432",
      appId: "1:529626240432:web:ca9c80a061a555f6007275"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "pedidos");

    const PRODUTOS = [
        { nome: 'Delícia de abacaxi', tamanhos: [{t:'P',p:35}, {t:'G',p:55}] },
        { nome: 'Ouro branco', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Sonho de valsa', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Supreme de morango', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Bombom de morango', tamanhos: [{t:'P',p:50}, {t:'G',p:85}] },
        { nome: 'Bombom de uva', tamanhos: [{t:'P',p:50}, {t:'G',p:85}] },
        { nome: 'Kinder Bueno', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Torta de brownie', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Ferrero Rocher', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Pudim tradicional', tamanhos: [{t:'M',p:35}, {t:'G',p:75}] },
        { nome: 'Pudim ninho com Nutella', tamanhos: [{t:'M',p:50}, {t:'G',p:85}] },
        { nome: 'Pudim ninho com geleia de morango', tamanhos: [{t:'M',p:50}, {t:'G',p:85}] },
        { nome: 'Brownietone', tamanhos: [{t:'250g',p:25}, {t:'500g',p:55}] },
        { nome: 'Sobremesa na taça - Delícia de abacaxi', tamanhos: [{t:'Único',p:100}] },
        { nome: 'Sobremesa na taça - Torta brownie', tamanhos: [{t:'Único',p:120}] },
        { nome: '4 brigadeiros', tamanhos: [{t:'Único',p:14}] },
        { nome: '4 mini brownies recheados', tamanhos: [{t:'Único',p:18}] },
        { nome: 'Mini bolo', tamanhos: [{t:'Único',p:15}], requerSabor: true },
        { nome: 'Bolo médio', tamanhos: [{t:'Único',p:50}], requerSabor: true },
        { nome: 'Empadão de carne de sol', tamanhos: [{t:'Único',p:85}] },
        { nome: 'Empadão de frango', tamanhos: [{t:'Único',p:85}] }
    ];

    const BAIRROS = [
        "Aeroporto", "Antônio Vieira", "Betolândia", "Brejo Seco", "Campo Alegre", 
        "Carité", "Centro", "Cidade Universitária", "Franciscanos", "Frei Damião", 
        "Horto", "Jardim Gonzaga", "João Cabral", "José Geraldo da Cruz", "Juvêncio Santana", 
        "Lagoa Seca", "Leandro Bezerra de Menezes", "Limoeiro", "Monsenhor Francisco de Sá Barreto", 
        "Monsenhor Murilo de Sá Barreto", "Novo Juazeiro", "Palmeirinha", "Parque São Geraldo", 
        "Pedrinhas", "Pio XII", "Pirajá", "Planalto", "Professora Maria Geli", "Romeirão", 
        "Salesianos", "Salgadinho", "Santa Teresa", "São José", "São Miguel", "Socorro", 
        "Tiradentes", "Três Marias", "Triângulo", "OUTRO"
    ];

    let orders = [];
    let charts = { prod: null, fat: null };

    // --- LOGIN ---
    window.handleLogin = function(e) {
        e.preventDefault();
        const u = document.getElementById('loginUser').value.toLowerCase().trim();
        const p = document.getElementById('loginPass').value;
        if(u === 'divinepudimgourmet' && p === '1810') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            initApp();
        } else { alert('Acesso negado.'); }
    };

    function initApp() {
        const bList = document.getElementById('cliBairro');
        if(bList.options.length <= 1) {
            BAIRROS.forEach(b => {
                let opt = document.createElement('option');
                opt.value = b; opt.textContent = b; bList.appendChild(opt);
            });
        }
        onSnapshot(query(colRef), (snapshot) => {
            orders = [];
            snapshot.forEach(doc => { let d = doc.data(); d.fbId = doc.id; orders.push(d); });
            refreshAll();
        });
        document.getElementById('dataPed').valueAsDate = new Date();
    }

    // --- LÓGICA DE PAGAMENTO ---
    window.toggleAdiantamento = function() {
        const chk = document.getElementById('checkAdiantamento');
        const area = document.getElementById('areaAdiantamento');
        const lblRestante = document.getElementById('lblFormaRestante');
        const inpPago = document.getElementById('valPago');
        
        if(chk.checked) {
            area.style.display = 'grid'; 
            lblRestante.innerText = "Forma de Pagamento (Do Restante)";
        } else {
            area.style.display = 'none';
            inpPago.value = 0;
            lblRestante.innerText = "Forma de Pagamento (Valor Total)";
            calcTotal();
        }
    };

    // --- LÓGICA DE ITENS ---
    window.addItem = function(data = null) {
        const id = Date.now() + Math.floor(Math.random() * 1000); 
        const html = `
        <div class="item-row" id="row-${id}">
            <div><select class="i-prod" onchange="updItem(${id})"><option value="">Selecione...</option>${PRODUTOS.map(p => `<option value="${p.nome}" ${p.requerSabor ? 'data-sabor="1"' : ''}>${p.nome}</option>`).join('')}<option value="OUTRO">Outro (Manual)</option></select><input type="text" class="i-cust" style="display:none; margin-top:5px; width:100%" placeholder="Digite aqui..."></div>
            <div><select class="i-tam" onchange="updPrice(${id})"><option>-</option></select></div>
            <div><input type="number" class="i-qtd" value="1" onchange="calcTotal()" style="width:60px"></div>
            <div><input type="number" class="i-prc" step="0.01" onchange="calcTotal()" style="width:80px"></div>
            <div class="i-total" style="font-weight:bold; color:#666">R$ 0,00</div>
            <button type="button" class="btn btn-danger" onclick="this.parentElement.remove(); calcTotal()">X</button>
        </div>`;
        document.getElementById('itemsContainer').insertAdjacentHTML('beforeend', html);

        if(data) {
            const row = document.getElementById(`row-${id}`);
            const selProd = row.querySelector('.i-prod');
            const selTam = row.querySelector('.i-tam');
            const inpCust = row.querySelector('.i-cust');
            
            let baseName = data.prod;
            let flavor = '';
            const match = data.prod.match(/^(.*)\s\((.*)\)$/);
            if (match && PRODUTOS.find(p => p.nome === match[1])) {
               baseName = match[1];
               flavor = match[2];
            }

            const produtoObj = PRODUTOS.find(p => p.nome === baseName);

            if(produtoObj) {
                selProd.value = baseName;
                selTam.innerHTML = produtoObj.tamanhos.map(t => `<option value="${t.t}" data-p="${t.p}">${t.t}</option>`).join('');
                selTam.value = data.tam;
                if(produtoObj.requerSabor) {
                    inpCust.style.display = 'block';
                    inpCust.placeholder = "Sabor";
                    inpCust.value = flavor;
                }
            } else {
                selProd.value = 'OUTRO';
                inpCust.style.display = 'block';
                inpCust.placeholder = "Produto";
                inpCust.value = data.prod;
                selTam.innerHTML = `<option value="Único">Único</option>`;
                selTam.value = data.tam;
            }

            row.querySelector('.i-qtd').value = data.qtd;
            row.querySelector('.i-prc').value = data.prc;
            row.querySelector('.i-total').innerText = fmtMoeda(data.qtd * data.prc);
        }
    };

    window.updItem = function(id) {
        const row = document.getElementById(`row-${id}`);
        const sel = row.querySelector('.i-prod');
        const tam = row.querySelector('.i-tam');
        const cust = row.querySelector('.i-cust');
        const prc = row.querySelector('.i-prc');
        const opt = sel.options[sel.selectedIndex];
        const val = sel.value;

        if(val === 'OUTRO') {
            cust.style.display = 'block'; cust.placeholder = "Produto"; tam.innerHTML = '<option value="Único">Único</option>'; prc.value = '';
        } else {
            const p = PRODUTOS.find(x => x.nome === val);
            if(p) {
                tam.innerHTML = p.tamanhos.map(t => `<option value="${t.t}" data-p="${t.p}">${t.t}</option>`).join('');
                if(p.tamanhos[0]) prc.value = p.tamanhos[0].p;
            }
            if (opt.getAttribute('data-sabor')) { cust.style.display = 'block'; cust.placeholder = "Sabor"; } else { cust.style.display = 'none'; cust.value = ''; }
        }
        calcTotal();
    };

    window.updPrice = function(id) {
        const row = document.getElementById(`row-${id}`);
        const tam = row.querySelector('.i-tam');
        const prc = row.querySelector('.i-prc');
        const opt = tam.options[tam.selectedIndex];
        if(opt && opt.dataset.p) { prc.value = opt.dataset.p; calcTotal(); }
    };

    window.quickUpdateStatus = async function(id, newStatus) {
        try { await updateDoc(doc(db, "pedidos", id), { status: newStatus }); } catch(e) {}
    };

    window.checkTipoEntrega = function() {
        const tipo = document.getElementById('tipoEntrega').value;
        const divDel = document.getElementById('deliveryFields');
        const divRet = document.getElementById('retiradaFields');
        if (tipo === 'Delivery') {
            divDel.style.display = 'block'; divRet.style.display = 'none';
            document.getElementById('cliEnd').required = true;
            document.getElementById('cliBairro').required = true;
            document.getElementById('turnoEntrega').required = true;
        } else if (tipo === 'Retirada no local') {
            divDel.style.display = 'none'; divRet.style.display = 'block';
            document.getElementById('cliEnd').required = false;
            document.getElementById('cliBairro').required = false;
            document.getElementById('turnoEntrega').required = false;
        } else {
            divDel.style.display = 'none'; divRet.style.display = 'none';
        }
    };

    window.checkBairro = function() {
        const s = document.getElementById('cliBairro');
        const i = document.getElementById('cliBairroOutro');
        i.style.display = s.value === 'OUTRO' ? 'block' : 'none';
        if(s.value === 'OUTRO') i.required = true; else i.required = false;
    };

    window.saveOrder = async function(e) {
        e.preventDefault();
        let itens = []; 
        document.querySelectorAll('.item-row').forEach(row => {
            const prodSel = row.querySelector('.i-prod').value;
            let prodNome = prodSel === 'OUTRO' ? row.querySelector('.i-cust').value : prodSel;
            const custField = row.querySelector('.i-cust');
            if (custField.style.display !== 'none' && prodSel !== 'OUTRO') { prodNome += ` (${custField.value})`; }
            const qtd = parseFloat(row.querySelector('.i-qtd').value); const prc = parseFloat(row.querySelector('.i-prc').value);
            itens.push({ prod: prodNome, tam: row.querySelector('.i-tam').value, qtd: qtd, prc: prc });
        });

        const tipo = document.getElementById('tipoEntrega').value;
        let bairroFinal = '-'; let endFinal = '-'; let turnoFinal = '-'; let horarioRet = '';

        if(tipo === 'Delivery') {
            const bairroSel = document.getElementById('cliBairro').value;
            bairroFinal = bairroSel === 'OUTRO' ? document.getElementById('cliBairroOutro').value : bairroSel;
            const num = document.getElementById('cliNumero').value;
            endFinal = document.getElementById('cliEnd').value + (num ? `, Nº ${num}` : '');
            turnoFinal = document.getElementById('turnoEntrega').value;
        } else {
            endFinal = 'Retirada na Loja';
            horarioRet = document.getElementById('horarioRetirada').value;
            if(horarioRet) turnoFinal = `Retirada às ${horarioRet}`; else turnoFinal = 'Retirada';
        }

        const taxa = parseFloat(document.getElementById('valTaxa').value) || 0;
        const pago = parseFloat(document.getElementById('valPago').value) || 0;
        
        let sumItens = itens.reduce((acc, i) => acc + (i.qtd * i.prc), 0);
        const totalFinal = sumItens + taxa;
        const restante = totalFinal - pago;

        // Captura formas de pagamento
        const formaSinal = document.getElementById('formaPagSinal').value;
        const formaRestante = document.getElementById('formaPagRestante').value;

        const obj = {
            cliente: document.getElementById('cliNome').value, tel: document.getElementById('cliTel').value, cep: document.getElementById('cliCep').value,
            end: endFinal, bairro: bairroFinal, tipoEntrega: tipo, turno: turnoFinal,
            dataPedido: document.getElementById('dataPed').value, dataEntrega: document.getElementById('dataEnt').value,
            status: document.getElementById('statusPed').value, itens: itens, total: totalFinal, pago: pago, taxa: taxa, restante: restante,
            // Pagamentos
            formaPagRestante: formaRestante, 
            formaPagSinal: pago > 0 ? formaSinal : null,
            obs: document.getElementById('obs').value
        };

        try {
            const editId = document.getElementById('editFirebaseId').value;
            if(editId) { await updateDoc(doc(db, "pedidos", editId), obj); alert('Atualizado!'); }
            else { await addDoc(colRef, obj); alert('Salvo!'); }
            closeOrderModal();
        } catch(err) { console.error(err); alert('Erro ao salvar.'); }
    };

    window.editOrder = function(id) {
        const o = orders.find(x => x.fbId === id); if(!o) return; 
        showNewOrderModal();
        document.getElementById('editFirebaseId').value = id;
        document.getElementById('cliNome').value = o.cliente;
        document.getElementById('cliTel').value = o.tel;
        
        const isDelivery = o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada'));
        document.getElementById('tipoEntrega').value = isDelivery ? 'Delivery' : 'Retirada no local';
        checkTipoEntrega();

        if(isDelivery) {
            document.getElementById('cliCep').value = o.cep || '';
            if(o.end && o.end.includes(', Nº')) { 
                const parts = o.end.split(', Nº'); 
                document.getElementById('cliEnd').value = parts[0].trim(); 
                document.getElementById('cliNumero').value = parts[1].trim(); 
            } else { 
                document.getElementById('cliEnd').value = o.end; 
            }
            
            const sel = document.getElementById('cliBairro');
            let found = false;
            for(let i=0; i<sel.options.length; i++) {
                if(sel.options[i].value === o.bairro) { sel.selectedIndex = i; found = true; break; }
            }
            if(!found) { sel.value = 'OUTRO'; checkBairro(); document.getElementById('cliBairroOutro').value = o.bairro; }
            
            document.getElementById('turnoEntrega').value = (o.turno === 'Manhã' || o.turno === 'Tarde') ? o.turno : '';
        } else {
            if(o.turno.includes('às')) { document.getElementById('horarioRetirada').value = o.turno.split('às')[1].trim(); }
        }

        document.getElementById('dataPed').value = o.dataPedido; document.getElementById('dataEnt').value = o.dataEntrega; document.getElementById('statusPed').value = o.status;
        
        // Pagamento
        document.getElementById('valPago').value = o.pago; 
        document.getElementById('valTaxa').value = o.taxa || 0; 
        document.getElementById('formaPagRestante').value = o.formaPagRestante || '';
        document.getElementById('obs').value = o.obs || '';
        
        // Adiantamento
        if(o.pago > 0) {
            document.getElementById('checkAdiantamento').checked = true;
            document.getElementById('areaAdiantamento').style.display = 'grid';
            document.getElementById('formaPagSinal').value = o.formaPagSinal || '';
            document.getElementById('lblFormaRestante').innerText = "Forma de Pagamento (Do Restante)";
        } else {
            document.getElementById('checkAdiantamento').checked = false;
            document.getElementById('areaAdiantamento').style.display = 'none';
            document.getElementById('lblFormaRestante').innerText = "Forma de Pagamento (Valor Total)";
        }

        document.getElementById('itemsContainer').innerHTML = '';
        o.itens.forEach(i => addItem(i));
        
        calcTotal();
    };

    window.calcTotal = function() {
        let itemsTotal = 0; 
        document.querySelectorAll('.item-row').forEach(row => { 
            const q = parseFloat(row.querySelector('.i-qtd').value) || 0; 
            const p = parseFloat(row.querySelector('.i-prc').value) || 0; 
            const sub = q * p; 
            row.querySelector('.i-total').innerText = fmtMoeda(sub); 
            itemsTotal += sub; 
        });
        const taxa = parseFloat(document.getElementById('valTaxa').value) || 0; 
        const pago = parseFloat(document.getElementById('valPago').value) || 0;
        const finalTotal = itemsTotal + taxa;
        document.getElementById('displayTotal').innerText = fmtMoeda(finalTotal); 
        document.getElementById('valRest').value = fmtMoeda(finalTotal - pago);
    };

    window.renderOrdersList = function(list = orders) {
        const div = document.getElementById('ordersList');
        if(!list.length) { div.innerHTML = '<p style="grid-column:1/-1;text-align:center;padding:40px;color:#aaa">Nenhum pedido encontrado.</p>'; return; }
        const sorted = [...list].sort((a,b) => new Date(a.dataEntrega) - new Date(b.dataEntrega));

        div.innerHTML = sorted.map((o, index) => {
            const numPedido = (index + 1).toString().padStart(3, '0');
            const statusClass = 'card-' + (o.status ? o.status.toLowerCase().split(' ')[0] : 'confirmado');
            
            const itensHtml = o.itens.map(i => `<div class="item-line"><span>${i.qtd}x ${i.prod} (${i.tam})</span> <span>${fmtMoeda(i.prc*i.qtd)}</span></div>`).join('');
            
            let endInfo = o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada')) 
                ? `<i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${o.end}, ${o.bairro}`
                : `<i class="fas fa-store" style="color:var(--primary)"></i> Retirada na Loja`;

            const opts = ['Pedido confirmado','Produzindo','Pronto','Em rota','Entregue'].map(s => `<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join('');

            // Lógica de exibição do pagamento no CARD
            let pagInfo = '';
            if (o.pago > 0) {
                // Tem sinal
                pagInfo = `<div class="finance-row"><span>Restante:</span> <span>${o.formaPagRestante || '?'}</span></div>`;
            } else {
                // Sem sinal
                pagInfo = `<div class="finance-row"><span>Pagamento:</span> <span>${o.formaPagRestante || '?'}</span></div>`;
            }

            return `
            <div class="order-card ${statusClass}">
                <div class="order-header">
                    <div>
                        <div class="order-id">#${numPedido}</div>
                        <div class="order-date">${fmtData(o.dataEntrega)} • ${o.turno}</div>
                    </div>
                    <select class="status-select" onchange="quickUpdateStatus('${o.fbId}', this.value)" style="background:#fff">${opts}</select>
                </div>
                <div class="order-body">
                    <div class="client-info">
                        <span class="client-name">${o.cliente}</span>
                        <div class="client-detail"><i class="fas fa-phone" style="font-size:11px"></i> ${o.tel}</div>
                        <div class="client-detail">${endInfo}</div>
                        ${o.obs ? `<div class="client-detail" style="color:#e11d48;font-style:italic"><i class="fas fa-comment"></i> ${o.obs}</div>` : ''}
                    </div>
                    <div class="items-box">${itensHtml}</div>
                    <div class="finance-box">
                        ${pagInfo}
                        <div class="finance-row"><span>Pago (Adiantado):</span> <span style="color:#10b981">${fmtMoeda(o.pago)}</span></div>
                        <div class="finance-total" style="display:flex;justify-content:space-between;color:${o.restante>0?'#ef4444':'#10b981'}">
                            <span>A PAGAR:</span> <span>${fmtMoeda(o.restante)}</span>
                        </div>
                    </div>
                </div>
                <div class="order-footer">
                    <button class="btn btn-card" onclick="editOrder('${o.fbId}')"><i class="fas fa-edit"></i> Editar</button>
                    <button class="btn btn-card" onclick="printOrder('${o.fbId}', '${numPedido}')"><i class="fas fa-print"></i> Cupom</button>
                    <button class="btn btn-card" onclick="deleteOrder('${o.fbId}')" style="color:#ef4444"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        }).join('');
    };

    // --- UTILS ---
    window.buscarCep = async function() {
        let cep = document.getElementById('cliCep').value.replace(/\D/g,'');
        if(cep.length === 8) {
            try {
                let r = await fetch(`https://viacep.com.br/ws/${cep}/json/`); let d = await r.json();
                if(!d.erro) { document.getElementById('cliEnd').value = d.logradouro; const bSelect = document.getElementById('cliBairro'); let found = false; for (let i = 0; i < bSelect.options.length; i++) { if (bSelect.options[i].value.toLowerCase() === d.bairro.toLowerCase()) { bSelect.selectedIndex = i; found = true; break; } } if (!found) { bSelect.value = 'OUTRO'; document.getElementById('cliBairroOutro').value = d.bairro; } checkBairro(); }
            } catch(e) {}
        }
    };
    window.showNewOrderModal = function() { document.getElementById('orderForm').reset(); document.getElementById('itemsContainer').innerHTML = ''; document.getElementById('editFirebaseId').value = ''; document.getElementById('dataPed').valueAsDate = new Date(); document.getElementById('checkAdiantamento').checked = false; toggleAdiantamento(); document.getElementById('orderModal').classList.add('active'); checkTipoEntrega(); addItem(); };
    window.closeOrderModal = function() { document.getElementById('orderModal').classList.remove('active'); };
    window.deleteOrder = async function(id) { if(confirm('Excluir?')) await deleteDoc(doc(db, "pedidos", id)); };
    window.fmtMoeda = v => v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    window.fmtData = d => d.split('-').reverse().join('/');
    window.searchOrders = function() { applyFilters(); };
    window.clearFilters = function() { document.getElementById('searchInput').value = ''; document.getElementById('filterData').value = ''; document.getElementById('filterBairro').value = ''; document.getElementById('filterStatus').value = ''; document.getElementById('filterTipo').value = ''; document.getElementById('filterTurno').value = ''; applyFilters(); };
    window.showTab = function(e, tabId) { if(e) e.preventDefault(); document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active'); if(e && e.target) e.target.closest('.tab-btn').classList.add('active'); if(tabId === 'graficos') window.renderCharts(); };
    window.refreshAll = function() { renderDashboard(); renderOrdersList(); populateBairroFilter(); };
    window.applyFilters = function() {
        const term = document.getElementById('searchInput').value.toLowerCase(); const date = document.getElementById('filterData').value; const bairro = document.getElementById('filterBairro').value; const status = document.getElementById('filterStatus').value; const tipo = document.getElementById('filterTipo').value; const turno = document.getElementById('filterTurno').value;
        const filtered = orders.filter(o => { let ok = true; if(term && !o.cliente.toLowerCase().includes(term)) ok = false; if(date && o.dataEntrega !== date) ok = false; if(bairro && o.bairro !== bairro) ok = false; if(status && o.status !== status) ok = false; if(tipo && tipo !== 'Todas' && o.tipoEntrega !== tipo) ok = false; if(turno && turno !== 'Todos' && o.turno !== turno && !o.turno.includes(turno)) ok = false; return ok; }); renderOrdersList(filtered);
    };
    window.printOrder = function(id, numPedido) {
        const o = orders.find(x => x.fbId === id); const w = window.open('', '', 'width=300,height=600');
        let headerEnd = ""; let bodyEnd = "";
        if (o.tipoEntrega === 'Delivery' || !o.turno.includes('Retirada')) { headerEnd = "DELIVERY"; bodyEnd = `<div class="bold">ENDEREÇO:</div><div>${o.end}</div><div>${o.bairro}</div>${o.obs ? `<div style="margin-top:5px"><b>Ref:</b> ${o.obs}</div>` : ''}`; } else { headerEnd = "RETIRADA"; bodyEnd = `<div class="center bold">CLIENTE VAI RETIRAR</div>`; }
        w.document.write(`<html><head><style>body { font-family: 'Courier New', monospace; font-size: 12px; margin: 0; padding: 5px; width: 58mm; } .center { text-align: center; } .line { border-bottom: 1px dashed #000; margin: 8px 0; } .row { display: flex; justify-content: space-between; } .bold { font-weight: bold; } .big { font-size: 14px; }</style></head><body><div class="center bold big">DIVINE PUDIM GOURMET</div><div class="center">88 98824-4346</div><div class="line"></div><div class="center bold big">PEDIDO #${numPedido}</div><div class="center bold">${headerEnd}</div><div class="center">${fmtData(o.dataEntrega)} - ${o.turno}</div><div class="line"></div><div class="bold">CLIENTE:</div><div>${o.cliente}</div><div>${o.tel}</div><div class="line"></div>${bodyEnd}<div class="line"></div><div class="bold">ITENS:</div>${o.itens.map(i=>`<div style="margin-bottom:3px">${i.qtd}x ${i.prod} (${i.tam})<br><div style="text-align:right">${fmtMoeda(i.prc*i.qtd)}</div></div>`).join('')}<div class="line"></div><div class="row"><span>Taxa:</span> <span>${fmtMoeda(o.taxa)}</span></div><div class="row bold big"><span>TOTAL:</span> <span>${fmtMoeda(o.total)}</span></div><div class="row"><span>Pago:</span> <span>${fmtMoeda(o.pago)}</span></div><div class="row bold"><span>FALTA:</span> <span>${fmtMoeda(o.restante)}</span></div><div class="line"></div><div class="center bold">Obrigado pela preferência!</div></body></html>`); setTimeout(() => { w.print(); w.close(); }, 500);
    };
    window.populateBairroFilter = function() { const b = [...new Set(orders.map(o => o.bairro))].sort(); document.getElementById('filterBairro').innerHTML = '<option value="">Todos</option>' + b.map(x => `<option>${x}</option>`).join(''); };
    window.exportBackup = function() { const b = new Blob([JSON.stringify(orders)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup.json'; a.click(); };
    window.handleImport = function(e) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (ev) => { try { const arr = JSON.parse(ev.target.result); if(confirm(`Importar ${arr.length} pedidos?`)) { for(let o of arr) { delete o.fbId; await addDoc(colRef, o); } alert('Concluído!'); } } catch(x) { alert('Erro arquivo invalido'); } }; r.readAsText(f); };
    window.exportToPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); doc.setFontSize(18); doc.text("Relatório de Pedidos - Divine Pudim Gourmet", 14, 20); doc.setFontSize(10); doc.text("Gerado em: " + new Date().toLocaleString(), 14, 28); const tableColumn = ["Entregue Em", "Cliente/Contato", "Endereço Completo", "Itens", "Total", "Pago", "Falta"]; const tableRows = []; orders.sort((a,b) => new Date(a.dataEntrega) - new Date(b.dataEntrega)).forEach(o => { const itemsStr = o.itens.map(i => `${i.qtd}x ${i.prod} (${i.tam})`).join('\n'); const endStr = o.tipoEntrega === 'Retirada no local' ? 'RETIRADA' : `${o.end}\n${o.bairro}\nObs: ${o.obs || '-'}`; tableRows.push([`${fmtData(o.dataEntrega)}\n${o.turno}`, `${o.cliente}\n${o.tel}`, endStr, itemsStr, fmtMoeda(o.total), fmtMoeda(o.pago), fmtMoeda(o.restante)]); }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, theme: 'grid', styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' }, columnStyles: { 0: {cellWidth:25}, 1:{cellWidth:35}, 2:{cellWidth:60}, 3:{cellWidth:70}, 4:{cellWidth:20, halign:'right'}, 5:{cellWidth:20, halign:'right'}, 6:{cellWidth:20, halign:'right'} } }); doc.save(`Relatorio_${new Date().toISOString().split('T')[0]}.pdf`); };
    window.exportToExcel = function() { const wb = XLSX.utils.book_new(); const data = orders.map(o => ({ "Data Entrega": fmtData(o.dataEntrega), "Tipo": o.tipoEntrega, "Turno": o.turno, "Status": o.status, "Cliente": o.cliente, "Telefone": o.tel, "Endereço": o.end, "Bairro": o.bairro, "Obs": o.obs, "Itens": o.itens.map(i => `${i.qtd}x ${i.prod}`).join('; '), "Total": o.total, "Pago": o.pago, "Restante": o.restante })); const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch:12}, {wch:15}, {wch:15}, {wch:15}, {wch:25}, {wch:15}, {wch:40}, {wch:15}, {wch:20}, {wch:50}]; XLSX.utils.book_append_sheet(wb, ws, "Pedidos"); XLSX.writeFile(wb, `Relatorio_${new Date().toISOString().split('T')[0]}.xlsx`); };
    window.renderCharts = function() { const ctxProd = document.getElementById('chartProd'); const ctxFat = document.getElementById('chartFat'); if(charts.prod) charts.prod.destroy(); if(charts.fat) charts.fat.destroy(); const counts = {}; orders.forEach(o => o.itens.forEach(i => { let key = `${i.prod} (${i.tam})`; counts[key] = (counts[key] || 0) + i.qtd; })); charts.prod = new Chart(ctxProd, { type: 'bar', data: { labels: Object.keys(counts), datasets: [{ label: 'Qtd', data: Object.values(counts), backgroundColor: '#ec4899' }] }, options: { responsive: true, maintainAspectRatio: false } }); const statusFat = {}; orders.forEach(o => statusFat[o.status] = (statusFat[o.status] || 0) + o.total); charts.fat = new Chart(ctxFat, { type: 'doughnut', data: { labels: Object.keys(statusFat), datasets: [{ data: Object.values(statusFat), backgroundColor: ['#3b82f6','#f59e0b','#8b5cf6','#06b6d4','#10b981'] }] }, options: { responsive: true, maintainAspectRatio: false } }); };
    window.renderDashboard = function() { document.getElementById('dashTotal').innerText = orders.length; const fat = orders.reduce((acc, o) => acc + (o.total || 0), 0); const recebido = orders.reduce((acc, o) => acc + (o.pago || 0), 0); const taxas = orders.reduce((acc, o) => acc + (o.taxa || 0), 0); const aReceber = orders.reduce((acc, o) => acc + (o.restante || 0), 0); document.getElementById('dashFaturado').innerText = fmtMoeda(fat); document.getElementById('dashRecebido').innerText = fmtMoeda(recebido); document.getElementById('dashTaxas').innerText = fmtMoeda(taxas); document.getElementById('dashReceber').innerText = fmtMoeda(aReceber); const counts = {}; orders.forEach(o => o.itens.forEach(i => { let key = `${i.prod} - ${i.tam}`; counts[key] = (counts[key] || 0) + i.qtd; })); const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]); document.getElementById('topProductsList').innerHTML = sorted.map(([k,v]) => `<div style="background:#f9f9f9; padding:12px; border-radius:8px; display:flex; justify-content:space-between; border-left:4px solid var(--primary)"><b>${k}</b><span style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:12px">${v} un</span></div>`).join(''); };
</script>
</body>
</html>
