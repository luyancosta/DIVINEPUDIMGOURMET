<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divine Pudim Gourmet - Sistema</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* ================= ESTILOS (CSS) ================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #ec4899; --primary-dark: #be185d; --primary-light: #fdf2f8;
            --accent: #ffd700; --white: #ffffff; --gray-50: #fafafa;
            --gray-200: #e5e5e5; --gray-600: #525252; --gray-800: #262626;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --transition: all 0.3s ease;
        }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #fdf2f8, #fce7f3); color: var(--gray-800); min-height: 100vh; padding-bottom: 40px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        /* HEADER */
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: var(--white); padding: 20px 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .logo { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--accent); font-size: 28px; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* BOTÕES */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: var(--transition); }
        .btn-header { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-header:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: var(--accent); color: var(--gray-800); font-weight: 700; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-800); }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        
        /* ABAS */
        .tabs-nav { background: var(--white); padding: 10px 0; position: sticky; top: 70px; z-index: 990; box-shadow: var(--shadow); margin-bottom: 20px; }
        .tabs-buttons { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: none; border: none; padding: 10px 20px; cursor: pointer; color: var(--gray-600); font-weight: 600; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--primary-light); border-radius: 8px 8px 0 0; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS & GRID */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: center; }
        .card-row { display: flex; align-items: center; gap: 15px; }
        .card-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; flex-shrink: 0; }
        .card h3 { font-size: 20px; font-weight: 700; margin-bottom: 5px; }
        .card p { font-size: 14px; color: var(--gray-600); }

        /* PEDIDOS */
        .search-bar, .filters { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 6px; font-family: inherit; }
        
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .order-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); border-left: 5px solid var(--primary); display: flex; flex-direction: column; }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; }
        .order-items { background: var(--gray-50); padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 14px; }
        .order-actions { margin-top: auto; display: flex; gap: 5px; padding-top: 10px; }

        /* STATUS COLORS */
        .st-confirmado { background: #dbeafe; color: #1e40af; }
        .st-produzindo { background: #fef3c7; color: #92400e; }
        .st-pronto { background: #ede9fe; color: #5b21b6; }
        .st-rota { background: #cffafe; color: #155e75; }
        .st-entregue { background: #d1fae5; color: #065f46; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 950px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { background: var(--primary); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 16px 16px 0 0; }
        .modal-body { padding: 30px; }
        
        /* FORM & INPUT GROUP (R$) */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        .input-group { position: relative; }
        .input-group span { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--gray-600); font-weight: bold; }
        .input-group input { padding-left: 35px; }

        /* TABELA DE ITENS NO MODAL */
        .items-header { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; 
            gap: 10px; 
            font-weight: bold; 
            color: var(--gray-600); 
            margin-bottom: 5px; 
            padding: 0 10px;
            font-size: 14px;
        }
        .item-row { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; 
            gap: 10px; 
            align-items: center; 
            margin-bottom: 10px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
        }
        @media(max-width: 700px) { 
            .items-header { display: none; }
            .item-row { grid-template-columns: 1fr; border: 1px solid #ddd; padding: 10px; border-radius: 8px; } 
        }

        /* PRINT */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 58mm; padding: 0; margin: 0; font-size: 12px; font-family: monospace; }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="container">
        <div class="header-content">
            <div class="logo"><i class="fas fa-birthday-cake"></i> Divine Pudim Gourmet</div>
            <div class="header-actions">
                <button class="btn btn-header" onclick="exportBackup()"><i class="fas fa-download"></i> Backup</button>
                <button class="btn btn-header" onclick="document.getElementById('importInput').click()"><i class="fas fa-upload"></i> Importar</button>
                <button class="btn btn-primary" onclick="showNewOrderModal()"><i class="fas fa-plus"></i> Novo Pedido</button>
            </div>
        </div>
    </div>
</header>

<div id="alertsArea"></div>

<nav class="tabs-nav">
    <div class="container">
        <div class="tabs-buttons">
            <button class="tab-btn active" onclick="showTab(event, 'dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
            <button class="tab-btn" onclick="showTab(event, 'pedidos')"><i class="fas fa-list"></i> Pedidos</button>
            <button class="tab-btn" onclick="showTab(event, 'graficos')"><i class="fas fa-chart-pie"></i> Gráficos</button>
        </div>
    </div>
</nav>

<section id="tabDashboard" class="tab-content active">
    <div class="container">
        <div class="dashboard-grid">
            <div class="card"><div class="card-row"><div class="card-icon" style="background:#ec4899"><i class="fas fa-shopping-bag"></i></div><div><h3 id="dashTotal">0</h3><p>Total Pedidos</p></div></div></div>
            <div class="card"><div class="card-row"><div class="card-icon" style="background:#8b5cf6"><i class="fas fa-dollar-sign"></i></div><div><h3 id="dashFaturado">R$ 0,00</h3><p>Total Faturado</p></div></div></div>
            <div class="card"><div class="card-row"><div class="card-icon" style="background:#10b981"><i class="fas fa-check-double"></i></div><div><h3 id="dashRecebido">R$ 0,00</h3><p>Valor Recebido</p></div></div></div>
            <div class="card"><div class="card-row"><div class="card-icon" style="background:#f59e0b"><i class="fas fa-hand-holding-usd"></i></div><div><h3 id="dashReceber">R$ 0,00</h3><p>A Receber</p></div></div></div>
            <div class="card"><div class="card-row"><div class="card-icon" style="background:#06b6d4"><i class="fas fa-motorcycle"></i></div><div><h3 id="dashTaxas">R$ 0,00</h3><p>Taxas Entrega</p></div></div></div>
        </div>
        
        <div class="card" style="display: block;">
            <h3 style="border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 15px;"><i class="fas fa-trophy"></i> Top Produtos (Por Tamanho)</h3>
            <div id="topProductsList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:10px;"></div>
        </div>
    </div>
</section>

<section id="tabPedidos" class="tab-content">
    <div class="container">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar cliente..." oninput="searchOrders()">
        </div>
        <div class="filters">
            <div class="filters-grid">
                <div><label>Data</label><input type="date" id="filterData" onchange="applyFilters()"></div>
                <div><label>Bairro</label><select id="filterBairro" onchange="applyFilters()"><option value="">Todos</option></select></div>
                <div><label>Status</label><select id="filterStatus" onchange="applyFilters()">
                    <option value="">Todos</option>
                    <option value="Pedido confirmado">Confirmado</option>
                    <option value="Produzindo">Produzindo</option>
                    <option value="Pronto">Pronto</option>
                    <option value="Em rota">Em rota</option>
                    <option value="Entregue">Entregue</option>
                </select></div>
                <div style="display:flex; align-items:end;"><button class="btn btn-secondary" onclick="clearFilters()" style="width:100%">Limpar</button></div>
            </div>
            <div style="margin-top:15px; display:flex; gap:10px; justify-content:center">
                <button class="btn btn-secondary" onclick="exportToPDF()">PDF</button>
                <button class="btn btn-secondary" onclick="exportToExcel()">Excel</button>
            </div>
        </div>
        <div id="ordersList" class="orders-grid"></div>
    </div>
</section>

<section id="tabGraficos" class="tab-content">
    <div class="container">
        <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));">
            <div class="card" style="display:block; min-height:300px">
                <h3>Produtos (Por Tamanho)</h3>
                <div style="height:250px; position:relative;">
                    <canvas id="chartProd"></canvas>
                </div>
            </div>
            <div class="card" style="display:block; min-height:300px">
                <h3>Faturamento</h3>
                <div style="height:250px; position:relative;">
                    <canvas id="chartFat"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<div id="orderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Novo Pedido</h2>
            <button onclick="closeOrderModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer">&times;</button>
        </div>
        <form id="orderForm" onsubmit="saveOrder(event)">
            <div class="modal-body">
                <div class="form-row">
                    <div><label>Nome *</label><input type="text" id="cliNome" required></div>
                    <div><label>WhatsApp *</label><input type="tel" id="cliTel" required></div>
                    <div><label>Turno *</label>
                        <select id="turnoEntrega" onchange="checkTurno()" required>
                            <option value="">Selecione</option>
                            <option value="Manhã">Manhã</option>
                            <option value="Tarde">Tarde</option>
                            <option value="Retirada no local">Retirada no local</option>
                        </select>
                    </div>
                </div>
                
                <div id="addressArea">
                    <div class="form-row">
                        <div><label>CEP</label><div style="display:flex; gap:5px"><input type="text" id="cliCep" onblur="buscarCep()"><button type="button" class="btn btn-secondary" onclick="buscarCep()"><i class="fas fa-search"></i></button></div></div>
                        <div style="grid-column: span 2"><label>Endereço *</label><input type="text" id="cliEnd"></div>
                    </div>
                    <div class="form-row">
                        <div><label>Bairro *</label>
                            <select id="cliBairro" onchange="checkBairro()">
                                <option value="">Selecione</option>
                                </select>
                            <input type="text" id="cliBairroOutro" style="display:none; margin-top:5px" placeholder="Digite o bairro">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div><label>Data Pedido</label><input type="date" id="dataPed" required></div>
                    <div><label>Data Entrega</label><input type="date" id="dataEnt" required></div>
                    <div><label>Status</label>
                        <select id="statusPed">
                            <option value="Pedido confirmado">Confirmado</option>
                            <option value="Produzindo">Produzindo</option>
                            <option value="Pronto">Pronto</option>
                            <option value="Em rota">Em rota</option>
                            <option value="Entregue">Entregue</option>
                        </select>
                    </div>
                </div>

                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee">
                
                <h3>Itens do Pedido</h3>
                <div class="items-header">
                    <div>Produto</div>
                    <div>Tamanho</div>
                    <div>Qtd</div>
                    <div>V. Unit</div>
                    <div>V. Total</div>
                    <div></div>
                </div>

                <div id="itemsContainer"></div>
                
                <button type="button" class="btn btn-primary" onclick="addItem()" style="width:100%; margin-top:10px">+ Adicionar Item</button>
                <div style="text-align:right; font-size:18px; font-weight:bold; margin-top:15px; color:var(--primary-dark)">
                    Total: <span id="displayTotal">R$ 0,00</span>
                </div>

                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee">

                <div class="form-row">
                    <div>
                        <label>Valor Pago</label>
                        <div class="input-group">
                            <span>R$</span>
                            <input type="number" step="0.01" id="valPago" oninput="calcTotal()">
                        </div>
                    </div>
                    <div>
                        <label>Taxa Entrega</label>
                        <div class="input-group">
                            <span>R$</span>
                            <input type="number" step="0.01" id="valTaxa" oninput="calcTotal()">
                        </div>
                    </div>
                    <div>
                        <label>Restante</label>
                        <div class="input-group">
                            <span>R$</span>
                            <input type="text" id="valRest" readonly>
                        </div>
                    </div>
                    <div><label>Pagamento</label>
                        <select id="formaPag">
                            <option value="Pix">Pix</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão">Cartão</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:10px"><label>Obs</label><textarea id="obs" rows="2"></textarea></div>

                <input type="hidden" id="editFirebaseId">
                
                <div style="margin-top:30px; display:flex; justify-content:flex-end; gap:10px">
                    <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Pedido</button>
                </div>
            </div>
        </form>
    </div>
</div>

<input type="file" id="importInput" style="display:none" onchange="handleImport(event)" accept=".json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIGURAÇÃO FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyBt_7_WLXqUvYqdCrTMQg7ySZUa4gSdEHY",
      authDomain: "divinepudimsystem.firebaseapp.com",
      projectId: "divinepudimsystem",
      storageBucket: "divinepudimsystem.firebasestorage.app",
      messagingSenderId: "529626240432",
      appId: "1:529626240432:web:ca9c80a061a555f6007275"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "pedidos");

    // --- DADOS ---
    const PRODUTOS = [
        { nome: 'Delícia de abacaxi', tamanhos: [{t:'P',p:35}, {t:'G',p:55}] },
        { nome: 'Pudim tradicional', tamanhos: [{t:'M',p:35}, {t:'G',p:75}] },
        { nome: 'Pudim Ninho c/ Nutella', tamanhos: [{t:'M',p:50}, {t:'G',p:85}] },
        { nome: 'Pudim Ninho c/ Morango', tamanhos: [{t:'M',p:50}, {t:'G',p:85}] },
        { nome: 'Brownietone 250g', tamanhos: [{t:'Único',p:25}] },
        { nome: 'Brownietone 500g', tamanhos: [{t:'Único',p:55}] },
        { nome: 'Taça Abacaxi', tamanhos: [{t:'Único',p:100}] },
        { nome: 'Taça Brownie', tamanhos: [{t:'Único',p:120}] },
        { nome: '4 Brigadeiros', tamanhos: [{t:'Único',p:14}] },
        { nome: 'Empadão', tamanhos: [{t:'Único',p:85}] }
    ];

    const BAIRROS = [
        "Aeroporto", "Antônio Vieira", "Betolândia", "Brejo Seco", "Campo Alegre", 
        "Carité", "Centro", "Cidade Universitária", "Franciscanos", "Frei Damião", 
        "Horto", "Jardim Gonzaga", "João Cabral", "José Geraldo da Cruz", "Juvêncio Santana", 
        "Lagoa Seca", "Leandro Bezerra de Menezes", "Limoeiro", "Monsenhor Francisco de Sá Barreto", 
        "Monsenhor Murilo de Sá Barreto", "Novo Juazeiro", "Palmeirinha", "Parque São Geraldo", 
        "Pedrinhas", "Pio XII", "Pirajá", "Planalto", "Professora Maria Geli", "Romeirão", 
        "Salesianos", "Salgadinho", "Santa Teresa", "São José", "São Miguel", "Socorro", 
        "Tiradentes", "Três Marias", "Triângulo", "OUTRO"
    ];

    let orders = [];
    let charts = { prod: null, fat: null };

    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        // Popula Bairros
        const bList = document.getElementById('cliBairro');
        BAIRROS.forEach(b => {
            let opt = document.createElement('option');
            opt.value = b;
            opt.textContent = b;
            bList.appendChild(opt);
        });

        // Firebase Listener
        onSnapshot(query(colRef), (snapshot) => {
            orders = [];
            snapshot.forEach(doc => {
                let d = doc.data();
                d.fbId = doc.id;
                orders.push(d);
            });
            refreshAll();
        });
        
        document.getElementById('dataPed').valueAsDate = new Date();
    });

    // --- FUNÇÕES DE NAVEGAÇÃO E RENDERIZAÇÃO ---
    window.showTab = function(e, tabId) {
        if(e) e.preventDefault();
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
        if(e && e.target) e.target.closest('.tab-btn').classList.add('active');
        
        if(tabId === 'graficos') window.renderCharts();
    };

    window.refreshAll = function() {
        renderDashboard();
        renderOrdersList();
        populateBairroFilter();
    };

    // --- DASHBOARD ATUALIZADO ---
    window.renderDashboard = function() {
        document.getElementById('dashTotal').innerText = orders.length;
        
        // Cálculos
        const fat = orders.reduce((acc, o) => acc + (o.total || 0), 0);
        const recebido = orders.reduce((acc, o) => acc + (o.pago || 0), 0);
        const taxas = orders.reduce((acc, o) => acc + (o.taxa || 0), 0);
        const aReceber = orders.reduce((acc, o) => acc + (o.restante || 0), 0);
        
        document.getElementById('dashFaturado').innerText = fmtMoeda(fat);
        document.getElementById('dashRecebido').innerText = fmtMoeda(recebido);
        document.getElementById('dashTaxas').innerText = fmtMoeda(taxas);
        document.getElementById('dashReceber').innerText = fmtMoeda(aReceber);

        // Top Produtos (Por Tamanho)
        const counts = {};
        orders.forEach(o => o.itens.forEach(i => {
            // Chave única: Nome + Tamanho
            let key = `${i.prod} - ${i.tam}`;
            counts[key] = (counts[key] || 0) + i.qtd;
        }));
        
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
        
        document.getElementById('topProductsList').innerHTML = sorted.map(([k,v]) => 
            `<div style="background:#f9f9f9; padding:12px; border-radius:8px; display:flex; justify-content:space-between; border-left:4px solid var(--primary)">
                <b>${k}</b> 
                <span style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:12px">${v} un</span>
            </div>`
        ).join('');
    };

    // --- LISTA DE PEDIDOS ---
    window.renderOrdersList = function(list = orders) {
        const div = document.getElementById('ordersList');
        if(!list.length) { div.innerHTML = '<p>Nenhum pedido encontrado.</p>'; return; }
        
        const sorted = [...list].sort((a,b) => new Date(a.dataEntrega) - new Date(b.dataEntrega));

        div.innerHTML = sorted.map((o, index) => {
            const numPedido = (index + 1).toString().padStart(3, '0');
            const stClass = 'st-' + (o.status ? o.status.toLowerCase().split(' ')[0] : 'confirmado');
            
            const itensHtml = o.itens.map(i => {
                return `<div>${i.qtd}x ${i.prod} (${i.tam}) - <span style="color:#666">${fmtMoeda(i.prc * i.qtd)}</span></div>`;
            }).join('');

            return `
            <div class="order-card">
                <div class="order-header">
                    <div><b>#${numPedido} - ${o.cliente}</b> <br> <small>${fmtData(o.dataEntrega)} • ${o.turno || '-'}</small></div>
                    <span class="status-badge ${stClass}">${o.status}</span>
                </div>
                <div class="order-items">
                    ${itensHtml}
                </div>
                <div style="font-size:13px; margin-bottom:10px; border-top:1px dashed #ddd; padding-top:5px">
                    <div style="display:flex; justify-content:space-between"><span>Taxa:</span> <span>${fmtMoeda(o.taxa)}</span></div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold"><span>Total:</span> <span>${fmtMoeda(o.total)}</span></div>
                    <div style="display:flex; justify-content:space-between; color:${o.restante > 0 ? 'red' : 'green'}"><span>Restante:</span> <span>${fmtMoeda(o.restante)}</span></div>
                </div>
                <div class="order-actions">
                    <button class="btn btn-secondary" onclick="editOrder('${o.fbId}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-secondary" onclick="printOrder('${o.fbId}', '${numPedido}')"><i class="fas fa-print"></i></button>
                    <button class="btn btn-danger" onclick="deleteOrder('${o.fbId}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        }).join('');
    };

    // --- GRÁFICOS (Por Tamanho) ---
    window.renderCharts = function() {
        const ctxProd = document.getElementById('chartProd');
        const ctxFat = document.getElementById('chartFat');

        if(charts.prod) charts.prod.destroy();
        if(charts.fat) charts.fat.destroy();

        // Dados Produtos (Nome + Tamanho)
        const counts = {};
        orders.forEach(o => o.itens.forEach(i => {
            let key = `${i.prod} (${i.tam})`;
            counts[key] = (counts[key] || 0) + i.qtd;
        }));
        
        charts.prod = new Chart(ctxProd, {
            type: 'bar',
            data: {
                labels: Object.keys(counts),
                datasets: [{ label: 'Qtd Vendida', data: Object.values(counts), backgroundColor: '#ec4899' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const statusFat = {};
        orders.forEach(o => statusFat[o.status] = (statusFat[o.status] || 0) + o.total);

        charts.fat = new Chart(ctxFat, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusFat),
                datasets: [{ data: Object.values(statusFat), backgroundColor: ['#3b82f6','#f59e0b','#8b5cf6','#06b6d4','#10b981'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    };

    // --- FORMULÁRIO ---
    window.checkTurno = function() {
        const turno = document.getElementById('turnoEntrega').value;
        const addrArea = document.getElementById('addressArea');
        const inputs = addrArea.querySelectorAll('input, select');
        
        if(turno === 'Retirada no local') {
            addrArea.style.display = 'none';
            inputs.forEach(i => i.required = false);
        } else {
            addrArea.style.display = 'block';
            document.getElementById('cliEnd').required = true;
            document.getElementById('cliBairro').required = true;
        }
    };

    window.checkBairro = function() {
        const s = document.getElementById('cliBairro');
        const i = document.getElementById('cliBairroOutro');
        i.style.display = s.value === 'OUTRO' ? 'block' : 'none';
        if(s.value === 'OUTRO') i.required = true;
        else i.required = false;
    };

    window.saveOrder = async function(e) {
        e.preventDefault();
        
        let itens = [];
        let totalItens = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const prodSel = row.querySelector('.i-prod').value;
            const prodNome = prodSel === 'OUTRO' ? row.querySelector('.i-cust').value : prodSel;
            const qtd = parseFloat(row.querySelector('.i-qtd').value);
            const prc = parseFloat(row.querySelector('.i-prc').value);
            totalItens += qtd * prc;
            
            itens.push({ prod: prodNome, tam: row.querySelector('.i-tam').value, qtd: qtd, prc: prc });
        });

        const turno = document.getElementById('turnoEntrega').value;
        let bairroFinal = '';
        let endFinal = '';
        
        if(turno !== 'Retirada no local') {
            const bairroSel = document.getElementById('cliBairro').value;
            bairroFinal = bairroSel === 'OUTRO' ? document.getElementById('cliBairroOutro').value : bairroSel;
            endFinal = document.getElementById('cliEnd').value;
        } else {
            bairroFinal = '-';
            endFinal = 'Retirada na Loja';
        }

        const taxa = parseFloat(document.getElementById('valTaxa').value) || 0;
        const pago = parseFloat(document.getElementById('valPago').value) || 0;
        const totalFinal = totalItens + taxa;
        const restante = totalFinal - pago;

        const obj = {
            cliente: document.getElementById('cliNome').value,
            tel: document.getElementById('cliTel').value,
            cep: document.getElementById('cliCep').value,
            end: endFinal,
            bairro: bairroFinal,
            turno: turno,
            dataPedido: document.getElementById('dataPed').value,
            dataEntrega: document.getElementById('dataEnt').value,
            status: document.getElementById('statusPed').value,
            itens: itens,
            total: totalFinal,
            pago: pago,
            taxa: taxa,
            restante: restante,
            pagamento: document.getElementById('formaPag').value,
            obs: document.getElementById('obs').value
        };

        try {
            const editId = document.getElementById('editFirebaseId').value;
            if(editId) {
                await updateDoc(doc(db, "pedidos", editId), obj);
                alert('Pedido atualizado!');
            } else {
                await addDoc(colRef, obj);
                alert('Pedido salvo!');
            }
            closeOrderModal();
        } catch(err) {
            console.error(err);
            alert('Erro ao salvar. Tente novamente.');
        }
    };

    window.addItem = function(data = null) {
        const id = Date.now();
        const html = `
        <div class="item-row" id="row-${id}">
            <div>
                <select class="i-prod" onchange="updItem(${id})">
                    <option value="">Selecione...</option>
                    ${PRODUTOS.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('')}
                    <option value="OUTRO">Personalizado</option>
                </select>
                <input type="text" class="i-cust" style="display:none; margin-top:5px; width:100%" placeholder="Nome do produto">
            </div>
            <div><select class="i-tam" onchange="updPrice(${id})"><option>-</option></select></div>
            <div><input type="number" class="i-qtd" value="1" onchange="calcTotal()" style="width:60px"></div>
            <div><input type="number" class="i-prc" step="0.01" onchange="calcTotal()" style="width:80px"></div>
            <div class="i-total" style="font-weight:bold; color:#666">R$ 0,00</div>
            <button type="button" class="btn btn-danger" onclick="this.parentElement.remove(); calcTotal()">X</button>
        </div>`;
        document.getElementById('itemsContainer').insertAdjacentHTML('beforeend', html);

        if(data) {
            const row = document.getElementById(`row-${id}`);
            const sel = row.querySelector('.i-prod');
            if(PRODUTOS.find(p => p.nome === data.prod)) {
                sel.value = data.prod;
                updItem(id);
                row.querySelector('.i-tam').value = data.tam;
            } else {
                sel.value = 'OUTRO';
                updItem(id);
                row.querySelector('.i-cust').value = data.prod;
                row.querySelector('.i-tam').innerHTML = `<option>${data.tam}</option>`;
            }
            row.querySelector('.i-qtd').value = data.qtd;
            row.querySelector('.i-prc').value = data.prc;
        }
    };

    window.updItem = function(id) {
        const row = document.getElementById(`row-${id}`);
        const val = row.querySelector('.i-prod').value;
        const tam = row.querySelector('.i-tam');
        const cust = row.querySelector('.i-cust');
        const prc = row.querySelector('.i-prc');

        if(val === 'OUTRO') {
            cust.style.display = 'block';
            tam.innerHTML = '<option value="Único">Único</option>';
            prc.value = '';
        } else {
            cust.style.display = 'none';
            const p = PRODUTOS.find(x => x.nome === val);
            if(p) {
                tam.innerHTML = p.tamanhos.map(t => `<option value="${t.t}" data-p="${t.p}">${t.t}</option>`).join('');
                updPrice(id);
            }
        }
    };

    window.updPrice = function(id) {
        const row = document.getElementById(`row-${id}`);
        const tam = row.querySelector('.i-tam');
        const opt = tam.options[tam.selectedIndex];
        if(opt && opt.dataset.p) {
            row.querySelector('.i-prc').value = opt.dataset.p;
            calcTotal();
        }
    };

    window.calcTotal = function() {
        let total = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const q = parseFloat(row.querySelector('.i-qtd').value) || 0;
            const p = parseFloat(row.querySelector('.i-prc').value) || 0;
            const sub = q * p;
            row.querySelector('.i-total').innerText = fmtMoeda(sub);
            total += sub;
        });
        
        const taxa = parseFloat(document.getElementById('valTaxa').value) || 0;
        const pago = parseFloat(document.getElementById('valPago').value) || 0;
        const final = total + taxa;
        
        document.getElementById('displayTotal').innerText = fmtMoeda(total);
        document.getElementById('valRest').value = fmtMoeda(final - pago);
    };

    // --- OUTROS ---
    window.showNewOrderModal = function() {
        document.getElementById('orderForm').reset();
        document.getElementById('itemsContainer').innerHTML = '';
        document.getElementById('editFirebaseId').value = '';
        document.getElementById('dataPed').valueAsDate = new Date();
        document.getElementById('orderModal').classList.add('active');
        checkTurno(); 
        addItem(); 
    };

    window.closeOrderModal = function() { document.getElementById('orderModal').classList.remove('active'); };

    window.deleteOrder = async function(id) {
        if(confirm('Excluir pedido? A numeração será reajustada.')) await deleteDoc(doc(db, "pedidos", id));
    };

    window.editOrder = function(id) {
        const o = orders.find(x => x.fbId === id);
        if(!o) return;
        showNewOrderModal();
        document.getElementById('editFirebaseId').value = id;
        document.getElementById('cliNome').value = o.cliente;
        document.getElementById('cliTel').value = o.tel;
        document.getElementById('turnoEntrega').value = o.turno || '';
        checkTurno();

        if(o.turno !== 'Retirada no local') {
            document.getElementById('cliCep').value = o.cep || '';
            document.getElementById('cliEnd').value = o.end;
            const sel = document.getElementById('cliBairro');
            if([...sel.options].some(op => op.value === o.bairro)) sel.value = o.bairro;
            else {
                sel.value = 'OUTRO';
                checkBairro();
                document.getElementById('cliBairroOutro').value = o.bairro;
            }
        }

        document.getElementById('dataPed').value = o.dataPedido;
        document.getElementById('dataEnt').value = o.dataEntrega;
        document.getElementById('statusPed').value = o.status;
        document.getElementById('valPago').value = o.pago;
        document.getElementById('valTaxa').value = o.taxa || 0;
        document.getElementById('formaPag').value = o.pagamento;
        document.getElementById('obs').value = o.obs || '';

        document.getElementById('itemsContainer').innerHTML = '';
        o.itens.forEach(i => addItem(i));
        setTimeout(calcTotal, 100);
    };

    window.printOrder = function(id, numPedido) {
        const o = orders.find(x => x.fbId === id);
        const w = window.open('', '', 'width=300,height=600');
        w.document.write(`
            <html><head><style>
                body { font-family: 'Courier New', monospace; font-size: 12px; margin: 0; padding: 5px; width: 58mm; }
                .center { text-align: center; }
                .line { border-bottom: 1px dashed #000; margin: 5px 0; }
                .row { display: flex; justify-content: space-between; }
                .bold { font-weight: bold; }
            </style></head><body>
                <div class="center bold">DIVINE PUDIM GOURMET</div>
                <div class="center">Pedido #${numPedido}</div>
                <div class="line"></div>
                <div><b>Cli:</b> ${o.cliente}</div>
                <div><b>Tel:</b> ${o.tel}</div>
                <div><b>End:</b> ${o.end}</div>
                <div><b>Bairro:</b> ${o.bairro}</div>
                <div><b>Entrega:</b> ${fmtData(o.dataEntrega)} (${o.turno})</div>
                <div class="line"></div>
                <div class="bold">ITENS:</div>
                ${o.itens.map(i => `<div>${i.qtd}x ${i.prod} (${i.tam})<br><div style="text-align:right">${fmtMoeda(i.prc*i.qtd)}</div></div>`).join('')}
                <div class="line"></div>
                <div class="row"><span>Taxa:</span> <span>${fmtMoeda(o.taxa)}</span></div>
                <div class="row bold" style="font-size:14px"><span>TOTAL:</span> <span>${fmtMoeda(o.total)}</span></div>
                <div class="row"><span>Pago:</span> <span>${fmtMoeda(o.pago)}</span></div>
                <div class="row bold"><span>RESTANTE:</span> <span>${fmtMoeda(o.restante)}</span></div>
                <div class="line"></div>
                <div class="center">Obrigado pela preferência!</div>
            </body></html>
        `);
        setTimeout(() => { w.print(); w.close(); }, 500);
    };

    window.fmtMoeda = v => v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    window.fmtData = d => d.split('-').reverse().join('/');
    
    // Filtros e Util
    window.searchOrders = function() { applyFilters(); };
    window.clearFilters = function() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterData').value = '';
        document.getElementById('filterBairro').value = '';
        document.getElementById('filterStatus').value = '';
        applyFilters();
    };
    window.applyFilters = function() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const date = document.getElementById('filterData').value;
        const bairro = document.getElementById('filterBairro').value;
        const status = document.getElementById('filterStatus').value;

        const filtered = orders.filter(o => {
            let ok = true;
            if(term && !o.cliente.toLowerCase().includes(term)) ok = false;
            if(date && o.dataEntrega !== date) ok = false;
            if(bairro && o.bairro !== bairro) ok = false;
            if(status && o.status !== status) ok = false;
            return ok;
        });
        renderOrdersList(filtered);
    };
    window.populateBairroFilter = function() {
        const b = [...new Set(orders.map(o => o.bairro))].sort();
        document.getElementById('filterBairro').innerHTML = '<option value="">Todos</option>' + b.map(x => `<option>${x}</option>`).join('');
    };
    window.buscarCep = async function() {
        let cep = document.getElementById('cliCep').value.replace(/\D/g,'');
        if(cep.length === 8) {
            let r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            let d = await r.json();
            if(!d.erro) document.getElementById('cliEnd').value = d.logradouro;
        }
    };
    window.exportBackup = function() {
        const b = new Blob([JSON.stringify(orders)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'backup.json';
        a.click();
    };
    window.handleImport = function(e) {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = async (ev) => {
            try {
                const arr = JSON.parse(ev.target.result);
                if(confirm(`Importar ${arr.length} pedidos?`)) {
                    for(let o of arr) { delete o.fbId; await addDoc(colRef, o); }
                    alert('Concluído!');
                }
            } catch(x) { alert('Erro arquivo invalido'); }
        };
        r.readAsText(f);
    };
    window.exportToPDF = function() { /* Placeholder */ };
    window.exportToExcel = function() { /* Placeholder */ };
</script>
</body>
</html>
