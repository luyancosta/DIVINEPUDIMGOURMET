<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBt_7_WLXqUvYqdCrTMQg7ySZUa4gSdEHY",
      authDomain: "divinepudimsystem.firebaseapp.com",
      projectId: "divinepudimsystem",
      storageBucket: "divinepudimsystem.firebasestorage.app",
      messagingSenderId: "529626240432",
      appId: "1:529626240432:web:ca9c80a061a555f6007275"
    };

    // Inicializa Firebase
    let app, db, colRef, stockCol;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        colRef = collection(db, "pedidos");
        stockCol = collection(db, "estoque");
        console.log("Firebase conectado com sucesso");
    } catch (error) {
        console.error("Erro ao conectar Firebase:", error);
        alert("Erro de conexão com o banco de dados. Verifique a internet.");
    }

    // --- DADOS E CONFIGURAÇÕES ---
    const INITIAL_STOCK_DATA = [
        { prod: 'Delícia de abacaxi', tam: 'G', qtd: 6 }, { prod: 'Delícia de abacaxi', tam: 'P', qtd: 6 },
        { prod: 'Ouro branco', tam: 'P', qtd: 3 }, { prod: 'Supreme de morango', tam: 'P', qtd: 2 },
        { prod: 'Supreme de morango', tam: 'G', qtd: 4 }, { prod: 'Pudim tradicional', tam: 'M', qtd: 13 }, 
        { prod: 'Pudim tradicional', tam: 'G', qtd: 2 }, { prod: 'Ferrero Rocher', tam: 'P', qtd: 1 },
        { prod: 'Bombom de morango', tam: 'G', qtd: 2 }, { prod: 'Bombom de uva', tam: 'G', qtd: 1 }, 
        { prod: 'Bombom de morango', tam: 'P', qtd: 2 }
    ];

    const PRODUTOS = [
        { nome: 'Delícia de abacaxi', tamanhos: [{t:'P',p:35}, {t:'G',p:55}] },
        { nome: 'Ouro branco', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Sonho de valsa', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Supreme de morango', tamanhos: [{t:'P',p:35}, {t:'G',p:75}] },
        { nome: 'Bombom de morango', tamanhos: [{t:'P',p:50}, {t:'G',p:85}] },
        { nome: 'Bombom de uva', tamanhos: [{t:'P',p:50}, {t:'G',p:85}] },
        { nome: 'Kinder Bueno', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Torta de brownie', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Ferrero Rocher', tamanhos: [{t:'P',p:55}, {t:'G',p:95}] },
        { nome: 'Pudim tradicional', tamanhos: [{t:'M',p:35}, {t:'G',p:75}] },
        { nome: 'Pudim ninho com Nutella', tamanhos: [{t:'M',p:50}, {t:'G',p:85}] },
        { nome: 'Pudim ninho com geleia de morango', tamanhos: [{t:'M',p:50}, {t:'G',p:85}] },
        { nome: 'Brownietone', tamanhos: [{t:'250g',p:25}, {t:'500g',p:55}] },
        { nome: 'Sobremesa na taça - Delícia de abacaxi', tamanhos: [{t:'Único',p:100}] },
        { nome: 'Sobremesa na taça - Torta brownie', tamanhos: [{t:'Único',p:120}] },
        { nome: '4 brigadeiros', tamanhos: [{t:'Único',p:14}] },
        { nome: '4 mini brownies recheados', tamanhos: [{t:'Único',p:18}] },
        { nome: 'Mini bolo', tamanhos: [{t:'Único',p:15}], requerSabor: true },
        { nome: 'Bolo médio', tamanhos: [{t:'Único',p:50}], requerSabor: true },
        { nome: 'Empadão de carne de sol', tamanhos: [{t:'Único',p:85}] },
        { nome: 'Empadão de frango', tamanhos: [{t:'Único',p:85}] }
    ];

    const BAIRROS = ["Aeroporto", "Antônio Vieira", "Betolândia", "Brejo Seco", "Campo Alegre", "Carité", "Centro", "Cidade Universitária", "Franciscanos", "Frei Damião", "Horto", "Jardim Gonzaga", "João Cabral", "José Geraldo da Cruz", "Juvêncio Santana", "Lagoa Seca", "Leandro Bezerra de Menezes", "Limoeiro", "Monsenhor Francisco de Sá Barreto", "Monsenhor Murilo de Sá Barreto", "Novo Juazeiro", "Palmeirinha", "Parque São Geraldo", "Pedrinhas", "Pio XII", "Pirajá", "Planalto", "Professora Maria Geli", "Romeirão", "Salesianos", "Salgadinho", "Santa Teresa", "São José", "São Miguel", "Socorro", "Tiradentes", "Três Marias", "Triângulo", "OUTRO"];

    const SEQUENCIA_LOGICA_BAIRROS = ["Salesianos", "Santo Antônio", "Santa Teresa", "Socorro", "Centro", "São Miguel", "Romeirão", "Pirajá", "Franciscanos", "Limoeiro", "João Cabral", "Horto", "Triângulo", "Antônio Vieira", "São José", "Frei Damião", "Jardim Gonzaga", "Lagoa Seca", "Planalto", "Cidade Universitária", "Campo Alegre", "Betolândia", "Aeroporto", "Novo Juazeiro", "Tiradentes", "Pedrinhas", "Brejo Seco"];

    let orders = [];
    let activeRouteOrders = [];
    let stockData = {};
    let charts = { prod: null, fat: null };
    let sortableInstance = null;
    const DEFAULT_PRINT_CONFIG = { title: 'DIVINE PUDIM', subtitle: 'GOURMET', phone: '88 98824-4346', msg: 'Obrigado pela preferência!', social: '@divinepudimgourmet' };

    // --- FUNÇÕES GLOBAIS DE SETUP ---
    window.openPrintConfig = function() { 
        const cfg = JSON.parse(localStorage.getItem('printConfig')) || DEFAULT_PRINT_CONFIG; 
        if(document.getElementById('cfgTitle')) document.getElementById('cfgTitle').value = cfg.title; 
        if(document.getElementById('cfgSubtitle')) document.getElementById('cfgSubtitle').value = cfg.subtitle; 
        if(document.getElementById('cfgPhone')) document.getElementById('cfgPhone').value = cfg.phone; 
        if(document.getElementById('cfgMsg')) document.getElementById('cfgMsg').value = cfg.msg; 
        if(document.getElementById('cfgSocial')) document.getElementById('cfgSocial').value = cfg.social; 
        document.getElementById('printConfigModal').classList.add('active'); 
    };

    window.savePrintConfig = function() { 
        const cfg = { title: document.getElementById('cfgTitle').value, subtitle: document.getElementById('cfgSubtitle').value, phone: document.getElementById('cfgPhone').value, msg: document.getElementById('cfgMsg').value, social: document.getElementById('cfgSocial').value }; 
        localStorage.setItem('printConfig', JSON.stringify(cfg)); 
        alert('Configuração salva!'); document.getElementById('printConfigModal').classList.remove('active'); 
    };

    window.resetPrintConfig = function() { if(confirm('Restaurar padrão?')) { localStorage.removeItem('printConfig'); window.openPrintConfig(); } };

    // --- FUNÇÃO LOGIN CORRIGIDA ---
    window.handleLogin = function(e) {
        e.preventDefault();
        const u = document.getElementById('loginUser').value.toLowerCase().trim();
        const p = document.getElementById('loginPass').value.trim(); // Remove espaços
        
        if(u === 'divinepudimgourmet' && p === '1810') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            initApp();
        } else { 
            alert('Acesso negado. Verifique usuário e senha.'); 
        }
    };

    window.applyInitialStock = async function() {
        if(!confirm("Isso vai redefinir o estoque baseando-se na sua contagem física atual - os pedidos pendentes.\n\nTem certeza?")) return;
        const pendingItems = {};
        orders.filter(o => o.status !== 'Entregue').forEach(o => {
            o.itens.forEach(item => {
                let baseName = item.prod;
                const match = item.prod.match(/^(.*)\s\((.*)\)$/);
                if (match && PRODUTOS.find(p => p.nome === match[1])) { baseName = match[1]; }
                const key = getStockKey(baseName, item.tam);
                pendingItems[key] = (pendingItems[key] || 0) + item.qtd;
            });
        });
        const promises = [];
        PRODUTOS.forEach(p => {
            p.tamanhos.forEach(t => {
                const key = getStockKey(p.nome, t.t);
                const initData = INITIAL_STOCK_DATA.find(i => i.prod.trim().toLowerCase() === p.nome.trim().toLowerCase() && i.tam.trim().toLowerCase() === t.t.trim().toLowerCase());
                const physicalCount = initData ? initData.qtd : 0;
                const reservedCount = pendingItems[key] || 0;
                const ref = doc(db, "estoque", key);
                promises.push(setDoc(ref, { emProducao: 0, pronto: physicalCount - reservedCount }));
            });
        });
        await Promise.all(promises);
        alert("Estoque redefinido com sucesso!");
        document.getElementById('printConfigModal').classList.remove('active');
    };

    function initApp() {
        const bList = document.getElementById('cliBairro');
        if(bList.options.length <= 1) {
            BAIRROS.forEach(b => { let opt = document.createElement('option'); opt.value = b; opt.textContent = b; bList.appendChild(opt); });
        }
        
        onSnapshot(query(colRef), (snapshot) => {
            orders = [];
            snapshot.forEach(doc => { let d = doc.data(); d.fbId = doc.id; orders.push(d); });
            orders.sort((a,b) => new Date(a.dataEntrega) - new Date(b.dataEntrega));
            orders.forEach((o, i) => o.displayId = (i + 1).toString().padStart(3, '0'));
            refreshAll();
        });

        onSnapshot(query(stockCol), (snapshot) => {
            stockData = {};
            snapshot.forEach(doc => { stockData[doc.id] = doc.data(); });
            refreshAll();
        });

        document.getElementById('dataPed').value = new Date().toISOString().split('T')[0];
    }

    // --- FUNÇÕES DE ESTOQUE ---
    function getStockKey(prodName, tam) { return `${prodName}_${tam}`; }

    window.updateStock = async function(key, type, delta) {
        const currentRef = doc(db, "estoque", key);
        const currentSnap = await getDoc(currentRef);
        let newData = currentSnap.exists() ? currentSnap.data() : { emProducao: 0, pronto: 0 };
        newData[type] = (newData[type] || 0) + delta;
        await setDoc(currentRef, newData);
    };

    window.finishProduction = async function(key) {
        const currentRef = doc(db, "estoque", key);
        const currentSnap = await getDoc(currentRef);
        let newData = currentSnap.exists() ? currentSnap.data() : { emProducao: 0, pronto: 0 };
        if (newData.emProducao > 0) { newData.emProducao -= 1; newData.pronto = (newData.pronto || 0) + 1; await setDoc(currentRef, newData); } 
        else { alert('Não há itens em produção para finalizar.'); }
    };

    window.renderStock = function() {
        const tbody = document.getElementById('stockTableBody');
        let html = '';
        
        PRODUTOS.forEach(p => {
            p.tamanhos.forEach(t => {
                const key = getStockKey(p.nome, t.t);
                const data = stockData[key] || { emProducao: 0, pronto: 0 };
                const emProd = data.emProducao || 0;
                const pronto = data.pronto || 0;
                
                const prontoClass = pronto < 0 ? 'stock-val stock-neg' : 'stock-val';
                const alertHtml = pronto < 0 ? '<span class="stock-alert">EM FALTA</span>' : '';
                
                html += `<tr><td>${p.nome}</td><td>${t.t}</td><td><div class="stock-control" style="justify-content:center"><button class="btn-circle btn-minus" onclick="updateStock('${key}', 'emProducao', -1)">-</button><span class="stock-val">${emProd}</span><button class="btn-circle btn-plus" onclick="updateStock('${key}', 'emProducao', 1)">+</button></div></td><td style="text-align:center"><button class="btn-finish" onclick="finishProduction('${key}')">Finalizar ➡️</button></td><td><div class="stock-control" style="justify-content:center"><button class="btn-circle btn-minus" onclick="updateStock('${key}', 'pronto', -1)">-</button><span class="${prontoClass}">${pronto}</span><button class="btn-circle btn-plus" onclick="updateStock('${key}', 'pronto', 1)">+</button>${alertHtml}</div></td></tr>`;
            });
        });
        tbody.innerHTML = html;
    };

    // --- RELATÓRIO PDF SIMPLIFICADO ---
    window.printStockReport = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const missing = []; // Falta produzir (Negativos)
        const surplus = []; // Sobrando (Positivos)

        PRODUTOS.forEach(p => {
            p.tamanhos.forEach(t => {
                const key = getStockKey(p.nome, t.t);
                const data = stockData[key] || { emProducao: 0, pronto: 0 };
                const realStock = data.pronto || 0; 

                if (realStock < 0) {
                    missing.push([p.nome, t.t, Math.abs(realStock)]);
                } else if (realStock > 0) {
                    surplus.push([p.nome, t.t, realStock]);
                }
            });
        });
        
        missing.sort((a,b) => a[0].localeCompare(b[0]));
        surplus.sort((a,b) => a[0].localeCompare(b[0]));
        
        doc.setFontSize(18); doc.text("Relatório de Situação de Estoque", 14, 20);
        doc.setFontSize(10); doc.text("Data: " + new Date().toLocaleString(), 14, 28);
        
        let currentY = 35;

        if (missing.length > 0) {
            doc.setFontSize(14); doc.setTextColor(220, 38, 38); 
            doc.text("FALTA PRODUZIR (Negativos na Tabela)", 14, currentY);
            currentY += 5;
            doc.autoTable({ head: [['Produto', 'Tamanho', 'Quantidade']], body: missing, startY: currentY, theme: 'grid', headStyles: { fillColor: [220, 38, 38] }, columnStyles: { 2: { halign: 'center', fontStyle: 'bold', textColor: [220, 38, 38] } } });
            currentY = doc.lastAutoTable.finalY + 15;
        }

        if (surplus.length > 0) {
            doc.setFontSize(14); doc.setTextColor(22, 163, 74); 
            doc.text("ESTÃO SOBRANDO (Positivos na Tabela)", 14, currentY);
            currentY += 5;
            doc.autoTable({ head: [['Produto', 'Tamanho', 'Quantidade']], body: surplus, startY: currentY, theme: 'grid', headStyles: { fillColor: [22, 163, 74] }, columnStyles: { 2: { halign: 'center', fontStyle: 'bold', textColor: [22, 163, 74] } } });
        }

        if (missing.length === 0 && surplus.length === 0) {
            doc.text("Tudo Zerado (Estoque Perfeito ou Vazio).", 14, currentY);
        }
        doc.save(`Relatorio_Estoque_${new Date().toISOString().split('T')[0]}.pdf`);
    };

    // --- RENDERIZADORES ---
    window.renderOrdersList = function(list = orders) {
        const div = document.getElementById('ordersList');
        if(!list.length) { div.innerHTML = '<p style="grid-column:1/-1;text-align:center;padding:40px;color:#aaa">Nenhum pedido encontrado para este filtro.</p>'; return; }
        
        const inventoryTracker = {}; 
        for (const [key, data] of Object.entries(stockData)) { inventoryTracker[key] = (data.pronto || 0); }
        
        orders.filter(o => o.status !== 'Entregue').forEach(o => {
            o.itens.forEach(i => {
                let baseName = i.prod;
                const match = i.prod.match(/^(.*)\s\((.*)\)$/);
                if (match && PRODUTOS.find(p => p.nome === match[1])) { baseName = match[1]; }
                const key = getStockKey(baseName, i.tam);
                inventoryTracker[key] = (inventoryTracker[key] || 0) + i.qtd;
            });
        });

        const badgeMap = {};
        orders.forEach(o => {
            const isDelivered = o.status === 'Entregue';
            o.itens.forEach((i, idx) => {
                const uniqueKey = `${o.fbId}_${idx}`;
                if (isDelivered) { badgeMap[uniqueKey] = 'DELIVERED'; return; }
                let baseName = i.prod;
                const match = i.prod.match(/^(.*)\s\((.*)\)$/);
                if (match && PRODUTOS.find(p => p.nome === match[1])) { baseName = match[1]; }
                const key = getStockKey(baseName, i.tam);
                if ((inventoryTracker[key] || 0) >= i.qtd) { inventoryTracker[key] -= i.qtd; badgeMap[uniqueKey] = 'OK'; } 
                else { inventoryTracker[key] = 0; badgeMap[uniqueKey] = 'WAIT'; }
            });
        });

        div.innerHTML = list.map((o, index) => {
            const numPedido = o.displayId; 
            const statusMap = { 'Pedido confirmado': 'card-confirmado', 'Produzindo': 'card-produzindo', 'Pronto': 'card-pronto', 'Em rota': 'card-rota', 'Entregue': 'card-entregue' };
            const statusClass = statusMap[o.status] || 'card-confirmado';
            const colorMap = { 'Pedido confirmado': '#000000', 'Produzindo': '#facc15', 'Pronto': '#3b82f6', 'Em rota': '#a855f7', 'Entregue': '#22c55e' };
            const selectBg = colorMap[o.status] || '#000000'; const selectColor = o.status === 'Produzindo' ? '#000000' : '#ffffff';
            
            const itensHtml = o.itens.map((i, idx) => {
                const uniqueKey = `${o.fbId}_${idx}`;
                let statusBadge = '';
                const badgeStatus = badgeMap[uniqueKey];
                if (badgeStatus === 'OK') statusBadge = '<span class="item-status-ok">✅ Estoque</span>';
                else if (badgeStatus === 'WAIT') statusBadge = '<span class="item-status-wait">⏳ Produzir</span>';
                return `<div class="item-line"><span>${i.qtd}x ${i.prod} (${i.tam})${statusBadge}</span> <span>${fmtMoeda(i.prc*i.qtd)}</span></div>`;
            }).join('');

            let endInfo = o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada')) ? `<i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${o.end}, ${o.bairro}` : `<i class="fas fa-store" style="color:var(--primary)"></i> Retirada na Loja`;
            const opts = ['Pedido confirmado','Produzindo','Pronto','Em rota','Entregue'].map(s => `<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join('');
            let pagInfo = o.restante <= 0.01 ? `<div class="payment-highlight" style="background:#dcfce7; color:#166534; border-color:#bbf7d0"><span>STATUS:</span> <span>PAGO TOTAL</span></div>` : (o.pago > 0 ? `<div class="payment-highlight"><span>Restante:</span> <span>${o.formaPagRestante || '?'}</span></div>` : `<div class="payment-highlight"><span>Total:</span> <span>${o.formaPagRestante || '?'}</span></div>`);
            
            return `<div class="order-card ${statusClass}"><div class="order-header"><div><div class="order-id">#${numPedido}</div><div class="order-date">${fmtData(o.dataEntrega)} • ${o.turno}</div></div><select class="status-select" onchange="quickUpdateStatus('${o.fbId}', this.value)" style="background:${selectBg}; color:${selectColor}">${opts}</select></div><div class="order-body"><div class="client-info"><span class="client-name">${o.cliente}</span><div class="client-detail"><i class="fas fa-phone" style="font-size:11px"></i> ${o.tel}</div><div class="client-detail">${endInfo}</div>${o.obs ? `<div class="client-detail" style="color:#e11d48;font-style:italic"><i class="fas fa-comment"></i> ${o.obs}</div>` : ''}</div><div class="items-box">${itensHtml}</div>${pagInfo}<div class="finance-box">${o.pago > 0 ? `<div class="finance-row"><span>Pago (Sinal):</span> <span style="color:#10b981">${fmtMoeda(o.pago)}</span></div>` : ''}<div class="finance-total" style="display:flex;justify-content:space-between;color:${o.restante>0?'#ef4444':'#10b981'}"><span>A PAGAR:</span> <span>${fmtMoeda(o.restante)}</span></div></div></div><div class="order-footer"><button class="btn btn-card" onclick="editOrder('${o.fbId}')"><i class="fas fa-edit"></i> Editar</button><button class="btn btn-card" onclick="printOrder('${o.fbId}', '${numPedido}')"><i class="fas fa-print"></i> Cupom</button><button class="btn btn-card" onclick="deleteOrder('${o.fbId}')" style="color:#ef4444"><i class="fas fa-trash"></i></button></div></div>`;
        }).join('');
    };

    // --- FUNÇÕES DE APOIO ---
    window.toggleAdiantamento = function() {
        const chk = document.getElementById('checkAdiantamento');
        if(chk.checked) document.getElementById('areaAdiantamentoInputs').style.display = 'flex';
        else { document.getElementById('areaAdiantamentoInputs').style.display = 'none'; document.getElementById('valPago').value = ''; calcTotal(); }
    };

    window.addItem = function(data = null) {
        const id = Date.now() + Math.floor(Math.random() * 1000); 
        const html = `<div class="item-row" id="row-${id}"><div><select class="i-prod" onchange="updItem(${id})" style="width:100%"><option value="">Selecione...</option>${PRODUTOS.map(p => `<option value="${p.nome}" ${p.requerSabor ? 'data-sabor="1"' : ''}>${p.nome}</option>`).join('')}<option value="OUTRO">Outro (Manual)</option></select><input type="text" class="i-cust" style="display:none; margin-top:5px; width:100%; font-size:12px" placeholder="Detalhe/Sabor"></div><div><select class="i-tam" onchange="updPrice(${id})" style="width:100%"><option>-</option></select></div><div><input type="number" class="i-qtd" value="1" onchange="calcTotal()" style="width:100%"></div><div><input type="number" class="i-prc" step="0.01" onchange="calcTotal()" style="width:100%"></div><div class="i-total" style="font-weight:bold; color:#666; font-size:13px">R$ 0,00</div><button type="button" class="btn btn-danger" onclick="this.parentElement.remove(); calcTotal()" style="padding:5px 10px"><i class="fas fa-trash"></i></button></div>`;
        document.getElementById('itemsContainer').insertAdjacentHTML('beforeend', html);
        if(data) {
            const row = document.getElementById(`row-${id}`); const selProd = row.querySelector('.i-prod'); const selTam = row.querySelector('.i-tam'); const inpCust = row.querySelector('.i-cust');
            let baseName = data.prod; let flavor = ''; const match = data.prod.match(/^(.*)\s\((.*)\)$/); if (match && PRODUTOS.find(p => p.nome === match[1])) { baseName = match[1]; flavor = match[2]; }
            const produtoObj = PRODUTOS.find(p => p.nome === baseName);
            if(produtoObj) { selProd.value = baseName; selTam.innerHTML = produtoObj.tamanhos.map(t => `<option value="${t.t}" data-p="${t.p}">${t.t}</option>`).join(''); selTam.value = data.tam; if(produtoObj.requerSabor) { inpCust.style.display = 'block'; inpCust.placeholder = "Sabor"; inpCust.value = flavor; } } 
            else { selProd.value = 'OUTRO'; inpCust.style.display = 'block'; inpCust.placeholder = "Produto"; inpCust.value = data.prod; selTam.innerHTML = `<option value="Único">Único</option>`; selTam.value = data.tam; }
            row.querySelector('.i-qtd').value = data.qtd; row.querySelector('.i-prc').value = data.prc; row.querySelector('.i-total').innerText = fmtMoeda(data.qtd * data.prc);
        }
    };

    window.updItem = function(id) { const row = document.getElementById(`row-${id}`); const sel = row.querySelector('.i-prod'); const tam = row.querySelector('.i-tam'); const cust = row.querySelector('.i-cust'); const prc = row.querySelector('.i-prc'); const opt = sel.options[sel.selectedIndex]; const val = sel.value; if(val === 'OUTRO') { cust.style.display = 'block'; cust.placeholder = "Produto"; tam.innerHTML = '<option value="Único">Único</option>'; prc.value = ''; } else { const p = PRODUTOS.find(x => x.nome === val); if(p) { tam.innerHTML = p.tamanhos.map(t => `<option value="${t.t}" data-p="${t.p}">${t.t}</option>`).join(''); if(p.tamanhos[0]) prc.value = p.tamanhos[0].p; } if (opt.getAttribute('data-sabor')) { cust.style.display = 'block'; cust.placeholder = "Sabor"; } else { cust.style.display = 'none'; cust.value = ''; } } calcTotal(); };
    window.updPrice = function(id) { const row = document.getElementById(`row-${id}`); const tam = row.querySelector('.i-tam'); const prc = row.querySelector('.i-prc'); const opt = tam.options[tam.selectedIndex]; if(opt && opt.dataset.p) { prc.value = opt.dataset.p; calcTotal(); } };
    window.quickUpdateStatus = async function(id, newStatus) { try { await updateDoc(doc(db, "pedidos", id), { status: newStatus }); } catch(e) {} };
    window.checkTipoEntrega = function() { 
        const tipo = document.getElementById('tipoEntrega').value; const divDel = document.getElementById('deliveryFields'); const divRet = document.getElementById('retiradaFields'); 
        const elEnd = document.getElementById('cliEnd'); const elBairro = document.getElementById('cliBairro'); const elTurno = document.getElementById('turnoEntrega');
        if (tipo === 'Delivery') { divDel.style.display = 'block'; divRet.style.display = 'none'; elEnd.required = true; elBairro.required = true; elTurno.required = true; } 
        else if (tipo === 'Retirada no local') { divDel.style.display = 'none'; divRet.style.display = 'block'; elEnd.required = false; elBairro.required = false; elTurno.required = false; } 
        else { divDel.style.display = 'none'; divRet.style.display = 'none'; elEnd.required = false; elBairro.required = false; elTurno.required = false; } 
    };
    window.checkBairro = function() { const s = document.getElementById('cliBairro'); const i = document.getElementById('cliBairroOutro'); i.style.display = s.value === 'OUTRO' ? 'block' : 'none'; if(s.value === 'OUTRO') i.required = true; else i.required = false; };
    async function processStockChanges(itemsList, action) {
        for (let item of itemsList) {
            let baseName = item.prod;
            const match = item.prod.match(/^(.*)\s\((.*)\)$/);
            if (match && PRODUTOS.find(p => p.nome === match[1])) { baseName = match[1]; }
            const exists = PRODUTOS.find(p => p.nome === baseName);
            if (exists) {
                const key = getStockKey(baseName, item.tam);
                const delta = action === 'add' ? item.qtd : -item.qtd;
                await updateStock(key, 'pronto', delta);
            }
        }
    }
    window.saveOrder = async function(e) { 
        e.preventDefault(); 
        try {
            let itens = []; 
            document.querySelectorAll('.item-row').forEach(row => { 
                const prodSel = row.querySelector('.i-prod').value; 
                let prodNome = prodSel === 'OUTRO' ? row.querySelector('.i-cust').value : prodSel; 
                const custField = row.querySelector('.i-cust'); 
                if (custField.style.display !== 'none' && prodSel !== 'OUTRO') { prodNome += ` (${custField.value})`; } 
                const qtd = parseFloat(row.querySelector('.i-qtd').value); 
                const prc = parseFloat(row.querySelector('.i-prc').value); 
                itens.push({ prod: prodNome, tam: row.querySelector('.i-tam').value, qtd: qtd, prc: prc }); 
            }); 
            
            const tipo = document.getElementById('tipoEntrega').value; 
            let bairroFinal = '-'; let endFinal = '-'; let turnoFinal = '-'; let horarioRet = ''; 
            if(tipo === 'Delivery') { 
                const bairroSel = document.getElementById('cliBairro').value; 
                bairroFinal = bairroSel === 'OUTRO' ? document.getElementById('cliBairroOutro').value : bairroSel; 
                const num = document.getElementById('cliNumero').value; 
                endFinal = document.getElementById('cliEnd').value + (num ? `, Nº ${num}` : ''); 
                turnoFinal = document.getElementById('turnoEntrega').value; 
            } else { endFinal = 'Retirada na Loja'; horarioRet = document.getElementById('horarioRetirada').value; if(horarioRet) turnoFinal = `Retirada às ${horarioRet}`; else turnoFinal = 'Retirada'; } 
            
            const taxa = parseFloat(document.getElementById('valTaxa').value) || 0; 
            const pago = parseFloat(document.getElementById('valPago').value) || 0; 
            const formaSinal = document.getElementById('formaPagSinal').value; 
            const formaRestante = document.getElementById('formaPagRestante').value; 
            let sumItens = itens.reduce((acc, i) => acc + (i.qtd * i.prc), 0); 
            const totalFinal = sumItens + taxa; 
            const restante = totalFinal - pago; 
            
            const obj = { cliente: document.getElementById('cliNome').value, tel: document.getElementById('cliTel').value, cep: document.getElementById('cliCep').value, end: endFinal, bairro: bairroFinal, tipoEntrega: tipo, turno: turnoFinal, dataPedido: document.getElementById('dataPed').value, dataEntrega: document.getElementById('dataEnt').value, status: document.getElementById('statusPed').value, itens: itens, total: totalFinal, pago: pago, taxa: taxa, restante: restante, formaPagRestante: formaRestante, formaPagSinal: pago > 0 ? formaSinal : null, obs: document.getElementById('obs').value }; 
            const editId = document.getElementById('editFirebaseId').value; 
            if(editId) { 
                const oldOrderRef = await getDoc(doc(db, "pedidos", editId));
                if (oldOrderRef.exists()) { await processStockChanges(oldOrderRef.data().itens, 'add'); }
                await updateDoc(doc(db, "pedidos", editId), obj); 
                await processStockChanges(itens, 'subtract');
                alert('Pedido Atualizado e Estoque Ajustado!'); 
            } else { 
                await addDoc(colRef, obj); 
                await processStockChanges(itens, 'subtract');
                alert('Pedido Salvo e Estoque Atualizado!'); 
            } 
            closeOrderModal(); 
        } catch(err) { console.error(err); alert('Erro ao salvar o pedido.'); } 
    };
    window.deleteOrder = async function(id) { 
        if(confirm('Tem certeza? Isso irá excluir o pedido e DEVOLVER os itens ao estoque.')) {
            try {
                const orderRef = await getDoc(doc(db, "pedidos", id));
                if (orderRef.exists()) { await processStockChanges(orderRef.data().itens, 'add'); }
                await deleteDoc(doc(db, "pedidos", id)); 
                alert('Pedido excluído e itens devolvidos ao estoque.');
            } catch(e) { alert('Erro ao excluir: ' + e.message); }
        }
    };
    window.editOrder = function(id) { 
        const o = orders.find(x => x.fbId === id); 
        if(!o) return; 
        showNewOrderModal(); 
        document.getElementById('editFirebaseId').value = id; 
        document.getElementById('cliNome').value = o.cliente; 
        document.getElementById('cliTel').value = o.tel; 
        const isDelivery = o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada')); 
        document.getElementById('tipoEntrega').value = isDelivery ? 'Delivery' : 'Retirada no local'; 
        checkTipoEntrega(); 
        if(isDelivery) { 
            document.getElementById('cliCep').value = o.cep || ''; 
            if(o.end && o.end.includes(', Nº')) { const parts = o.end.split(', Nº'); document.getElementById('cliEnd').value = parts[0].trim(); document.getElementById('cliNumero').value = parts[1].trim(); } else { document.getElementById('cliEnd').value = o.end; } 
            const sel = document.getElementById('cliBairro'); let found = false; for(let i=0; i<sel.options.length; i++) { if(sel.options[i].value === o.bairro) { sel.selectedIndex = i; found = true; break; } } if(!found) { sel.value = 'OUTRO'; checkBairro(); document.getElementById('cliBairroOutro').value = o.bairro; } 
            document.getElementById('turnoEntrega').value = (o.turno === 'Manhã' || o.turno === 'Tarde') ? o.turno : ''; 
        } else { if(o.turno.includes('às')) { document.getElementById('horarioRetirada').value = o.turno.split('às')[1].trim(); } } 
        document.getElementById('dataPed').value = o.dataPedido; document.getElementById('dataEnt').value = o.dataEntrega; document.getElementById('statusPed').value = o.status; document.getElementById('valPago').value = o.pago; document.getElementById('valTaxa').value = o.taxa || 0; document.getElementById('formaPagRestante').value = o.formaPagRestante || ''; document.getElementById('obs').value = o.obs || ''; 
        if(o.pago > 0) { document.getElementById('checkAdiantamento').checked = true; toggleAdiantamento(); document.getElementById('formaPagSinal').value = o.formaPagSinal || ''; } else { document.getElementById('checkAdiantamento').checked = false; toggleAdiantamento(); } 
        document.getElementById('itemsContainer').innerHTML = ''; o.itens.forEach(i => addItem(i)); calcTotal(); 
    };
    window.calcTotal = function() { 
        let itemsTotal = 0; 
        document.querySelectorAll('.item-row').forEach(row => { const q = parseFloat(row.querySelector('.i-qtd').value) || 0; const p = parseFloat(row.querySelector('.i-prc').value) || 0; const sub = q * p; row.querySelector('.i-total').innerText = fmtMoeda(sub); itemsTotal += sub; }); 
        const taxa = parseFloat(document.getElementById('valTaxa').value) || 0; const pago = parseFloat(document.getElementById('valPago').value) || 0; const finalTotal = itemsTotal + taxa; const valRestante = finalTotal - pago; 
        document.getElementById('displayTotal').innerText = fmtMoeda(finalTotal); document.getElementById('valRest').value = fmtMoeda(valRestante); 
    };
    window.markAsDelivered = async function(id, isChecked) {
        try { const newStatus = isChecked ? 'Entregue' : 'Em rota'; await updateDoc(doc(db, "pedidos", id), { status: newStatus }); } catch(e) { alert('Erro ao atualizar status: ' + e.message); }
    };
    window.renderRoutes = function() {
        const selectedTurno = document.getElementById('routeTurnoSelector').value;
        const listArea = document.getElementById('routeListArea');
        activeRouteOrders = orders.filter(o => { return (o.turno === selectedTurno || (o.turno && o.turno.includes(selectedTurno))) && o.status !== 'Entregue' && o.tipoEntrega === 'Delivery'; });
        document.getElementById('routeCount').innerText = activeRouteOrders.length;
        document.getElementById('routeTurnoDisplay').innerText = selectedTurno;
        if(activeRouteOrders.length === 0) { listArea.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px">Nenhuma entrega pendente para este turno.</p>'; return; }
        listArea.innerHTML = activeRouteOrders.map((o, idx) => `<div class="route-item" onclick="editOrder('${o.fbId}')" title="Clique para ver detalhes"><div class="route-handle" onclick="event.stopPropagation()"><i class="fas fa-grip-lines"></i></div><div class="route-check-container" onclick="event.stopPropagation()" title="Marcar como Entregue"><input type="checkbox" class="route-check" onchange="markAsDelivered('${o.fbId}', this.checked)"></div><div class="route-number">${idx + 1}</div><div class="route-details"><div class="route-addr">${o.end}</div><div class="route-bairro">${o.bairro}</div><div style="font-size:12px; color:#999">${o.cliente} (Ped #${o.displayId})</div></div></div>`).join('');
        if (sortableInstance) { sortableInstance.destroy(); }
        sortableInstance = Sortable.create(listArea, { animation: 150, handle: '.route-handle', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: function (evt) { Array.from(listArea.children).forEach((el, index) => { el.querySelector('.route-number').innerText = index + 1; }); } });
    };
    window.autoSortRouteLogic = function() {
        if(activeRouteOrders.length === 0) return;
        activeRouteOrders.sort((a, b) => { const idxA = SEQUENCIA_LOGICA_BAIRROS.indexOf(a.bairro); const idxB = SEQUENCIA_LOGICA_BAIRROS.indexOf(b.bairro); const valA = idxA === -1 ? 999 : idxA; const valB = idxB === -1 ? 999 : idxB; return valA - valB; });
        renderRoutes(); alert('Rota organizada por sequência lógica de bairros!');
    };
    window.openGoogleMapsRoute = function() {
        if(activeRouteOrders.length === 0) { alert('A rota está vazia.'); return; }
        let url = "https://www.google.com/maps/dir/Rua+Apolo+XI,+519,+Juazeiro+do+Norte+-+CE/";
        activeRouteOrders.forEach(o => { let cleanAddr = `${o.end}, ${o.bairro}, Juazeiro do Norte - CE`; url += encodeURIComponent(cleanAddr) + "/"; });
        window.open(url, '_blank');
    };
    window.renderOrdersList = function(list = orders) {
        const div = document.getElementById('ordersList');
        if(!list.length) { div.innerHTML = '<p style="grid-column:1/-1;text-align:center;padding:40px;color:#aaa">Nenhum pedido encontrado para este filtro.</p>'; return; }
        const inventoryTracker = {}; 
        for (const [key, data] of Object.entries(stockData)) { inventoryTracker[key] = (data.pronto || 0); }
        orders.filter(o => o.status !== 'Entregue').forEach(o => {
            o.itens.forEach(i => {
                let baseName = i.prod;
                const match = i.prod.match(/^(.*)\s\((.*)\)$/);
                if (match && PRODUTOS.find(p => p.nome === match[1])) { baseName = match[1]; }
                const key = getStockKey(baseName, i.tam);
                inventoryTracker[key] = (inventoryTracker[key] || 0) + i.qtd;
            });
        });
        const badgeMap = {};
        orders.forEach(o => {
            const isDelivered = o.status === 'Entregue';
            o.itens.forEach((i, idx) => {
                const uniqueKey = `${o.fbId}_${idx}`;
                if (isDelivered) { badgeMap[uniqueKey] = 'DELIVERED'; return; }
                let baseName = i.prod;
                const match = i.prod.match(/^(.*)\s\((.*)\)$/);
                if (match && PRODUTOS.find(p => p.nome === match[1])) { baseName = match[1]; }
                const key = getStockKey(baseName, i.tam);
                if ((inventoryTracker[key] || 0) >= i.qtd) { inventoryTracker[key] -= i.qtd; badgeMap[uniqueKey] = 'OK'; } 
                else { inventoryTracker[key] = 0; badgeMap[uniqueKey] = 'WAIT'; }
            });
        });
        div.innerHTML = list.map((o, index) => {
            const numPedido = o.displayId; 
            const statusMap = { 'Pedido confirmado': 'card-confirmado', 'Produzindo': 'card-produzindo', 'Pronto': 'card-pronto', 'Em rota': 'card-rota', 'Entregue': 'card-entregue' };
            const statusClass = statusMap[o.status] || 'card-confirmado';
            const colorMap = { 'Pedido confirmado': '#000000', 'Produzindo': '#facc15', 'Pronto': '#3b82f6', 'Em rota': '#a855f7', 'Entregue': '#22c55e' };
            const selectBg = colorMap[o.status] || '#000000'; const selectColor = o.status === 'Produzindo' ? '#000000' : '#ffffff';
            const itensHtml = o.itens.map((i, idx) => {
                const uniqueKey = `${o.fbId}_${idx}`;
                let statusBadge = '';
                const badgeStatus = badgeMap[uniqueKey];
                if (badgeStatus === 'OK') statusBadge = '<span class="item-status-ok">✅ Estoque</span>';
                else if (badgeStatus === 'WAIT') statusBadge = '<span class="item-status-wait">⏳ Produzir</span>';
                return `<div class="item-line"><span>${i.qtd}x ${i.prod} (${i.tam})${statusBadge}</span> <span>${fmtMoeda(i.prc*i.qtd)}</span></div>`;
            }).join('');
            let endInfo = o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada')) ? `<i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> ${o.end}, ${o.bairro}` : `<i class="fas fa-store" style="color:var(--primary)"></i> Retirada na Loja`;
            const opts = ['Pedido confirmado','Produzindo','Pronto','Em rota','Entregue'].map(s => `<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join('');
            let pagInfo = o.restante <= 0.01 ? `<div class="payment-highlight" style="background:#dcfce7; color:#166534; border-color:#bbf7d0"><span>STATUS:</span> <span>PAGO TOTAL</span></div>` : (o.pago > 0 ? `<div class="payment-highlight"><span>Restante:</span> <span>${o.formaPagRestante || '?'}</span></div>` : `<div class="payment-highlight"><span>Total:</span> <span>${o.formaPagRestante || '?'}</span></div>`);
            return `<div class="order-card ${statusClass}"><div class="order-header"><div><div class="order-id">#${numPedido}</div><div class="order-date">${fmtData(o.dataEntrega)} • ${o.turno}</div></div><select class="status-select" onchange="quickUpdateStatus('${o.fbId}', this.value)" style="background:${selectBg}; color:${selectColor}">${opts}</select></div><div class="order-body"><div class="client-info"><span class="client-name">${o.cliente}</span><div class="client-detail"><i class="fas fa-phone" style="font-size:11px"></i> ${o.tel}</div><div class="client-detail">${endInfo}</div>${o.obs ? `<div class="client-detail" style="color:#e11d48;font-style:italic"><i class="fas fa-comment"></i> ${o.obs}</div>` : ''}</div><div class="items-box">${itensHtml}</div>${pagInfo}<div class="finance-box">${o.pago > 0 ? `<div class="finance-row"><span>Pago (Sinal):</span> <span style="color:#10b981">${fmtMoeda(o.pago)}</span></div>` : ''}<div class="finance-total" style="display:flex;justify-content:space-between;color:${o.restante>0?'#ef4444':'#10b981'}"><span>A PAGAR:</span> <span>${fmtMoeda(o.restante)}</span></div></div></div><div class="order-footer"><button class="btn btn-card" onclick="editOrder('${o.fbId}')"><i class="fas fa-edit"></i> Editar</button><button class="btn btn-card" onclick="printOrder('${o.fbId}', '${numPedido}')"><i class="fas fa-print"></i> Cupom</button><button class="btn btn-card" onclick="deleteOrder('${o.fbId}')" style="color:#ef4444"><i class="fas fa-trash"></i></button></div></div>`;
        }).join('');
    };
    window.printOrder = function(id, numPedido) {
        const o = orders.find(x => x.fbId === id);
        const cfg = JSON.parse(localStorage.getItem('printConfig')) || DEFAULT_PRINT_CONFIG;
        const w = window.open('', '', 'width=300,height=600');
        let headerEnd = ""; let bodyEnd = "";
        if (o.tipoEntrega === 'Delivery' || (o.turno && !o.turno.includes('Retirada'))) { headerEnd = "DELIVERY"; bodyEnd = `<div class="destaque">ENDEREÇO:</div><div class="big">${o.end || ''}</div><div class="big">${o.bairro || ''}</div>${o.obs ? `<div style="margin-top:5px; border:1px solid #000; padding:2px"><b>OBS:</b> ${o.obs}</div>` : ''}`; } 
        else { headerEnd = "RETIRADA"; bodyEnd = `<div class="center big" style="border:2px solid #000; padding:5px; margin:5px 0;">CLIENTE VAI RETIRAR</div>`; }
        let paymentBox = o.restante <= 0.01 ? `<div class="box-pagamento">PAGO TOTAL</div>` : (o.pago > 0 ? `<div class="box-pagamento">RESTANTE: ${fmtMoeda(o.restante)}<br><small>(${o.formaPagRestante || '?'})</small></div>` : `<div class="box-pagamento">A PAGAR: ${fmtMoeda(o.total)}<br><small>(${o.formaPagRestante || '?'})</small></div>`);
        w.document.write(`<html><head><style>@page { margin: 0; size: auto; } body { margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; font-size: 12px; width: 48mm; color: #000; margin-right: 2mm; } .container { padding: 2px 2px 20px 2px; overflow-x: hidden; } * { font-weight: bold; line-height: 1.1; word-wrap: break-word; } .center { text-align: center; } .row { display: flex; justify-content: space-between; } .big { font-size: 14px; } .giant { font-size: 16px; text-transform: uppercase; } .line { border-bottom: 2px dashed #000; margin: 5px 0; } .destaque { font-size: 11px; text-transform: uppercase; margin-top: 5px; } .item-row { margin-bottom: 4px; padding-bottom: 2px; border-bottom: 1px dotted #ccc; } .box-pagamento { border: 2px solid #000; padding: 5px; margin-top: 10px; text-align: center; font-size: 14px; border-radius: 5px; background: #eee !important; -webkit-print-color-adjust: exact; } </style></head><body><div class="container"><div class="center giant">${cfg.title}</div><div class="center" style="font-size:11px">${cfg.subtitle}</div><div class="center" style="margin-bottom:5px">${cfg.phone}</div><div class="line"></div><div class="row big"><span>PEDIDO</span><span>#${numPedido}</span></div><div class="center giant" style="margin:5px 0; background:#000; color:#fff; -webkit-print-color-adjust: exact;">${headerEnd}</div><div class="center">${fmtData(o.dataEntrega)}</div><div class="center">${o.turno}</div><div class="line"></div><div class="destaque">CLIENTE:</div><div class="big">${o.cliente}</div><div>${o.tel}</div><div class="line"></div>${bodyEnd}<div class="line"></div><div class="destaque" style="margin-bottom:5px">ITENS:</div>${o.itens.map(i => `<div class="item-row"><div style="font-size:13px">${i.qtd}x ${i.prod}</div><div class="row"><span style="font-size:10px; font-weight:normal">${i.tam}</span><span>${fmtMoeda(i.prc * i.qtd)}</span></div></div>`).join('')}<div class="line"></div><div class="row" style="font-size:11px"><span>Taxa:</span><span>${fmtMoeda(o.taxa)}</span></div><div class="row" style="font-size:11px"><span>Sinal:</span><span>${fmtMoeda(o.pago)}</span></div><div class="row giant" style="margin-top:5px"><span>TOTAL:</span><span>${fmtMoeda(o.total)}</span></div>${paymentBox}<div class="center" style="margin-top:15px; font-size:10px;">${cfg.msg} <br>${cfg.social}</div><br>.</div></body></html>`);
        setTimeout(() => { w.document.close(); w.print(); w.close(); }, 500);
    };
    window.buscarCep = async function() { let cep = document.getElementById('cliCep').value.replace(/\D/g,''); if(cep.length === 8) { try { let r = await fetch(`https://viacep.com.br/ws/${cep}/json/`); let d = await r.json(); if(!d.erro) { document.getElementById('cliEnd').value = d.logradouro; const bSelect = document.getElementById('cliBairro'); let found = false; for (let i = 0; i < bSelect.options.length; i++) { if (bSelect.options[i].value.toLowerCase() === d.bairro.toLowerCase()) { bSelect.selectedIndex = i; found = true; break; } } if (!found) { bSelect.value = 'OUTRO'; document.getElementById('cliBairroOutro').value = d.bairro; } checkBairro(); } } catch(e) {} } };
    window.showNewOrderModal = function() { document.getElementById('orderForm').reset(); document.getElementById('itemsContainer').innerHTML = ''; document.getElementById('editFirebaseId').value = ''; document.getElementById('dataPed').value = new Date().toISOString().split('T')[0]; document.getElementById('checkAdiantamento').checked = false; toggleAdiantamento(); document.getElementById('orderModal').classList.add('active'); checkTipoEntrega(); addItem(); };
    window.closeOrderModal = function() { document.getElementById('orderModal').classList.remove('active'); };
    window.deleteOrder = async function(id) { if(confirm('Excluir?')) await deleteDoc(doc(db, "pedidos", id)); };
    window.fmtMoeda = v => v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
    window.fmtData = d => d.split('-').reverse().join('/');
    window.searchOrders = function() { applyFilters(); };
    window.clearFilters = function() { document.getElementById('searchInput').value = ''; document.getElementById('filterData').value = ''; document.getElementById('filterBairro').value = ''; document.getElementById('filterStatus').value = ''; document.getElementById('filterTipo').value = ''; document.getElementById('filterTurno').value = ''; applyFilters(); };
    window.showTab = function(e, tabId) { if(e) e.preventDefault(); document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active'); if(e && e.target) e.target.closest('.tab-btn').classList.add('active'); if(tabId === 'graficos') window.renderCharts(); if(tabId === 'rotas') window.renderRoutes(); if(tabId === 'estoque') window.renderStock(); };
    window.refreshAll = function() { renderDashboard(); renderOrdersList(); populateBairroFilter(); if(document.getElementById('tabRotas').classList.contains('active')) renderRoutes(); if(document.getElementById('tabEstoque').classList.contains('active')) renderStock(); };
    window.applyFilters = function() { const term = document.getElementById('searchInput').value.toLowerCase(); const date = document.getElementById('filterData').value; const bairro = document.getElementById('filterBairro').value; const status = document.getElementById('filterStatus').value; const tipo = document.getElementById('filterTipo').value; const turno = document.getElementById('filterTurno').value; const filtered = orders.filter(o => { let ok = true; if(term && !o.cliente.toLowerCase().includes(term)) ok = false; if(date && o.dataEntrega !== date) ok = false; if(bairro && o.bairro !== bairro) ok = false; if(status && o.status !== status) ok = false; if(tipo && tipo !== 'Todos' && o.tipoEntrega !== tipo) ok = false; if(turno && turno !== 'Todos' && o.turno !== turno && !o.turno.includes(turno)) ok = false; return ok; }); renderOrdersList(filtered); };
    window.exportProductSummary = function() {
        const term = document.getElementById('searchInput').value.toLowerCase(); const date = document.getElementById('filterData').value; const bairro = document.getElementById('filterBairro').value; const statusFilter = document.getElementById('filterStatus').value; const tipo = document.getElementById('filterTipo').value; const turno = document.getElementById('filterTurno').value;
        const filtered = orders.filter(o => { let ok = true; if(term && !o.cliente.toLowerCase().includes(term)) ok = false; if(date && o.dataEntrega !== date) ok = false; if(bairro && o.bairro !== bairro) ok = false; if(statusFilter && o.status !== statusFilter) ok = false; if(tipo && tipo !== 'Todos' && o.tipoEntrega !== tipo) ok = false; if(turno && turno !== 'Todos' && o.turno !== turno && !o.turno.includes(turno)) ok = false; return ok; });
        if (filtered.length === 0) { alert("Nenhum pedido encontrado com os filtros atuais."); return; }
        const toProduce = {}; const produced = {}; let hasData = false;
        filtered.forEach(o => { let targetMap = null; if (o.status === 'Pedido confirmado' || o.status === 'Produzindo') { targetMap = toProduce; } else if (o.status === 'Pronto') { targetMap = produced; } if (targetMap) { hasData = true; o.itens.forEach(i => { let key = `${i.prod} (${i.tam})`; if (!targetMap[key]) targetMap[key] = 0; targetMap[key] += i.qtd; }); } });
        if (!hasData) { alert("Nenhum pedido para produzir ou pronto encontrado (ignorando rota/entregue)."); return; }
        const rowsToProduce = Object.keys(toProduce).sort().map(k => [k, toProduce[k]]); const rowsProduced = Object.keys(produced).sort().map(k => [k, produced[k]]);
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(18); doc.text("Resumo de Produção", 14, 20); doc.setFontSize(10); let filterText = date ? `Data: ${fmtData(date)}` : "Todos os pedidos listados (Filtro Atual)"; doc.text(filterText, 14, 28);
        let currentY = 35;
        if (rowsToProduce.length > 0) { doc.setFontSize(14); doc.setTextColor(220, 38, 38); doc.text("FALTA PRODUZIR (Confirmados/Produzindo)", 14, currentY); currentY += 5; doc.autoTable({ head: [["Produto (Tamanho)", "Quantidade"]], body: rowsToProduce, startY: currentY, theme: 'grid', headStyles: { fillColor: [220, 38, 38] }, columnStyles: { 0: { cellWidth: 140 }, 1: { cellWidth: 40, halign: 'center', fontStyle: 'bold' } } }); currentY = doc.lastAutoTable.finalY + 15; }
        if (rowsProduced.length > 0) { doc.setFontSize(14); doc.setTextColor(22, 163, 74); doc.text("JÁ PRODUZIDOS (Prontos no Balcão/Freezer)", 14, currentY); currentY += 5; doc.autoTable({ head: [["Produto (Tamanho)", "Quantidade"]], body: rowsProduced, startY: currentY, theme: 'grid', headStyles: { fillColor: [22, 163, 74] }, columnStyles: { 0: { cellWidth: 140 }, 1: { cellWidth: 40, halign: 'center', fontStyle: 'bold' } } }); }
        doc.save(`Resumo_Producao_Separado_${new Date().toISOString().split('T')[0]}.pdf`);
    };
    window.populateBairroFilter = function() { const b = [...new Set(orders.map(o => o.bairro))].sort(); document.getElementById('filterBairro').innerHTML = '<option value="">Todos</option>' + b.map(x => `<option>${x}</option>`).join(''); };
    window.exportBackup = function() { const b = new Blob([JSON.stringify(orders)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup.json'; a.click(); };
    window.handleImport = function(e) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (ev) => { try { const arr = JSON.parse(ev.target.result); if(confirm(`Importar ${arr.length} pedidos?`)) { for(let o of arr) { delete o.fbId; await addDoc(colRef, o); await processStockChanges(o.itens, 'subtract'); } alert('Concluído!'); } } catch(x) { alert('Erro arquivo invalido'); } }; r.readAsText(f); };
    window.exportToPDF = function() { const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); doc.setFontSize(18); doc.text("Relatório de Pedidos - Divine Pudim Gourmet", 14, 20); doc.setFontSize(10); doc.text("Gerado em: " + new Date().toLocaleString(), 14, 28); const tableColumn = ["Entregue Em", "Cliente/Contato", "Endereço Completo", "Itens", "Total", "Pago", "Falta"]; const tableRows = []; orders.sort((a,b) => new Date(a.dataEntrega) - new Date(b.dataEntrega)).forEach(o => { const itemsStr = o.itens.map(i => `${i.qtd}x ${i.prod} (${i.tam})`).join('\n'); const endStr = o.tipoEntrega === 'Retirada no local' ? 'RETIRADA' : `${o.end}\n${o.bairro}\nObs: ${o.obs || '-'}`; tableRows.push([`${fmtData(o.dataEntrega)}\n${o.turno}`, `${o.cliente}\n${o.tel}`, endStr, itemsStr, fmtMoeda(o.total), fmtMoeda(o.pago), fmtMoeda(o.restante)]); }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, theme: 'grid', styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' }, columnStyles: { 0: {cellWidth:25}, 1:{cellWidth:35}, 2:{cellWidth:60}, 3:{cellWidth:70}, 4:{cellWidth:20, halign:'right'}, 5:{cellWidth:20, halign:'right'}, 6:{cellWidth:20, halign:'right'} } }); doc.save(`Relatorio_${new Date().toISOString().split('T')[0]}.pdf`); };
    window.exportToExcel = function() { const wb = XLSX.utils.book_new(); const data = orders.map(o => ({ "Data Entrega": fmtData(o.dataEntrega), "Tipo": o.tipoEntrega, "Turno": o.turno, "Status": o.status, "Cliente": o.cliente, "Telefone": o.tel, "Endereço": o.end, "Bairro": o.bairro, "Obs": o.obs, "Itens": o.itens.map(i => `${i.qtd}x ${i.prod}`).join('; '), "Total": o.total, "Pago": o.pago, "Restante": o.restante })); const ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{wch:12}, {wch:15}, {wch:15}, {wch:15}, {wch:25}, {wch:15}, {wch:40}, {wch:15}, {wch:20}, {wch:50}]; XLSX.utils.book_append_sheet(wb, ws, "Pedidos"); XLSX.writeFile(wb, `Relatorio_${new Date().toISOString().split('T')[0]}.xlsx`); };
    window.renderCharts = function() { const ctxProd = document.getElementById('chartProd'); const ctxFat = document.getElementById('chartFat'); if(charts.prod) charts.prod.destroy(); if(charts.fat) charts.fat.destroy(); const counts = {}; orders.forEach(o => o.itens.forEach(i => { let key = `${i.prod} (${i.tam})`; counts[key] = (counts[key] || 0) + i.qtd; })); charts.prod = new Chart(ctxProd, { type: 'bar', data: { labels: Object.keys(counts), datasets: [{ label: 'Qtd', data: Object.values(counts), backgroundColor: '#ec4899' }] }, options: { responsive: true, maintainAspectRatio: false } }); const statusFat = {}; orders.forEach(o => statusFat[o.status] = (statusFat[o.status] || 0) + o.total); charts.fat = new Chart(ctxFat, { type: 'doughnut', data: { labels: Object.keys(statusFat), datasets: [{ data: Object.values(statusFat), backgroundColor: ['#3b82f6','#f59e0b','#8b5cf6','#06b6d4','#10b981'] }] }, options: { responsive: true, maintainAspectRatio: false } }); };
    window.renderDashboard = function() { document.getElementById('dashTotal').innerText = orders.length; const fat = orders.reduce((acc, o) => acc + (o.total || 0), 0); const recebido = orders.reduce((acc, o) => acc + (o.pago || 0), 0); const taxas = orders.reduce((acc, o) => acc + (o.taxa || 0), 0); const aReceber = orders.reduce((acc, o) => acc + (o.restante || 0), 0); document.getElementById('dashFaturado').innerText = fmtMoeda(fat); document.getElementById('dashRecebido').innerText = fmtMoeda(recebido); document.getElementById('dashTaxas').innerText = fmtMoeda(taxas); document.getElementById('dashReceber').innerText = fmtMoeda(aReceber); const counts = {}; orders.forEach(o => o.itens.forEach(i => { let key = `${i.prod} - ${i.tam}`; counts[key] = (counts[key] || 0) + i.qtd; })); const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]); document.getElementById('topProductsList').innerHTML = sorted.map(([k,v]) => `<div style="background:#f9f9f9; padding:12px; border-radius:8px; display:flex; justify-content:space-between; border-left:4px solid var(--primary)"><b>${k}</b><span style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:12px">${v} un</span></div>`).join('');
    if(document.getElementById('dashProduzindo')) document.getElementById('dashProduzindo').innerText = orders.filter(o => o.status === 'Produzindo').length;
    if(document.getElementById('dashPronto')) document.getElementById('dashPronto').innerText = orders.filter(o => o.status === 'Pronto').length;
    if(document.getElementById('dashRota')) document.getElementById('dashRota').innerText = orders.filter(o => o.status === 'Em rota').length;
    if(document.getElementById('dashEntregue')) document.getElementById('dashEntregue').innerText = orders.filter(o => o.status === 'Entregue').length;
    };
</script>
